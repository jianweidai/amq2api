<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <title>Token ä½¿ç”¨é‡ä»ªè¡¨ç›˜</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root {
      --bg: #0a0a0b;
      --panel: #1c1c1e;
      --card: #252528;
      --text: #f5f5f7;
      --muted: #98989d;
      --accent: #0071e3;
      --accent-hover: #0077ed;
      --success: #34c759;
      --warning: #ff9500;
      --purple: #af52de;
      --pink: #ff2d55;
      --cyan: #5ac8fa;
      --orange: #ff9500;
      --border: #38383a;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
      line-height: 1.5;
      min-height: 100vh;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
      flex-wrap: wrap;
      gap: 16px;
    }
    .header-left h1 {
      font-size: 32px;
      font-weight: 600;
      letter-spacing: -0.02em;
    }
    .header-left p {
      color: var(--muted);
      font-size: 14px;
      margin-top: 4px;
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .period-selector {
      display: flex;
      background: var(--panel);
      border-radius: 10px;
      padding: 4px;
      gap: 4px;
    }
    .period-btn {
      background: transparent;
      color: var(--muted);
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .period-btn:hover {
      color: var(--text);
      background: var(--card);
    }
    .period-btn.active {
      background: var(--accent);
      color: white;
    }
    .refresh-btn {
      background: var(--panel);
      color: var(--text);
      border: none;
      border-radius: 10px;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .refresh-btn:hover {
      background: var(--card);
    }
    .refresh-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .refresh-btn .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--muted);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: none;
    }
    .refresh-btn.loading .spinner {
      display: block;
    }
    .refresh-btn.loading .refresh-icon {
      display: none;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <h1>ğŸ“Š Token ä»ªè¡¨ç›˜</h1>
        <p id="last-update">ä¸Šæ¬¡æ›´æ–°: --</p>
      </div>
      <div class="header-right">
        <div class="period-selector">
          <button class="period-btn" data-period="hour">å°æ—¶</button>
          <button class="period-btn active" data-period="day">ä»Šæ—¥</button>
          <button class="period-btn" data-period="week">æœ¬å‘¨</button>
          <button class="period-btn" data-period="month">æœ¬æœˆ</button>
          <button class="period-btn" data-period="all">å…¨éƒ¨</button>
        </div>
        <button class="refresh-btn" onclick="refreshData()">
          <span class="refresh-icon">ğŸ”„</span>
          <span class="spinner"></span>
          åˆ·æ–°
        </button>
      </div>
    </div>

    <div class="stats-grid" id="stats-grid">
      <!-- Cards will be rendered by JavaScript -->
    </div>
  </div>
</body>
</html>

<style>
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }
    .stat-card {
      background: var(--panel);
      border-radius: 16px;
      padding: 24px;
      display: flex;
      align-items: flex-start;
      gap: 16px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }
    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0;
    }
    .stat-icon.blue { background: rgba(0,113,227,0.2); }
    .stat-icon.green { background: rgba(52,199,89,0.2); }
    .stat-icon.purple { background: rgba(175,82,222,0.2); }
    .stat-icon.pink { background: rgba(255,45,85,0.2); }
    .stat-icon.cyan { background: rgba(90,200,250,0.2); }
    .stat-icon.orange { background: rgba(255,149,0,0.2); }
    .stat-icon.yellow { background: rgba(255,204,0,0.2); }
    .stat-content {
      flex: 1;
      min-width: 0;
    }
    .stat-label {
      color: var(--muted);
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 4px;
    }
    .stat-value {
      font-size: 32px;
      font-weight: 600;
      letter-spacing: -0.02em;
      line-height: 1.2;
    }
    .stat-value.small {
      font-size: 24px;
    }
    .stat-sub {
      color: var(--muted);
      font-size: 12px;
      margin-top: 4px;
    }
    .stat-sub span {
      color: var(--text);
      font-weight: 500;
    }
    .error-message {
      background: rgba(255,59,48,0.1);
      border: 1px solid rgba(255,59,48,0.3);
      color: #ff6b6b;
      padding: 16px 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      display: none;
    }
    .error-message.show {
      display: block;
    }
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-right {
        width: 100%;
        flex-direction: column;
      }
      .period-selector {
        width: 100%;
        justify-content: space-between;
      }
      .period-btn {
        flex: 1;
        padding: 8px 8px;
        font-size: 12px;
      }
      .refresh-btn {
        width: 100%;
        justify-content: center;
      }
      .stat-value {
        font-size: 28px;
      }
    }
</style>

<script>
// å½“å‰é€‰ä¸­çš„æ—¶é—´å‘¨æœŸ
let currentPeriod = 'day';
let autoRefreshInterval = null;

// æ•°å­—æ ¼å¼åŒ–ï¼šK/M åç¼€
function formatNumber(num) {
  if (num === null || num === undefined || isNaN(num)) return '0';
  num = Number(num);
  if (num >= 1000000) {
    return (num / 1000000).toFixed(2) + 'M';
  } else if (num >= 1000) {
    return (num / 1000).toFixed(2) + 'K';
  }
  return num.toLocaleString();
}

// è®¡ç®—ç¼“å­˜å‘½ä¸­ç‡
function calculateCacheHitRatio(cacheRead, cacheCreation) {
  const total = (cacheRead || 0) + (cacheCreation || 0);
  if (total === 0) return 0;
  return ((cacheRead || 0) / total) * 100;
}

// æ¸²æŸ“ç»Ÿè®¡å¡ç‰‡
function renderStats(data) {
  const grid = document.getElementById('stats-grid');
  const cacheHitRatio = calculateCacheHitRatio(data.cache_read_input_tokens, data.cache_creation_input_tokens);
  
  const cards = [
    {
      icon: 'ğŸ“Š',
      iconClass: 'blue',
      label: 'æ€» Token æ¶ˆè€—',
      value: formatNumber(data.total_tokens || 0),
      sub: `è¾“å…¥: <span>${formatNumber(data.input_tokens || 0)}</span> | è¾“å‡º: <span>${formatNumber(data.output_tokens || 0)}</span>`
    },
    {
      icon: 'ğŸ“¨',
      iconClass: 'green',
      label: 'è¯·æ±‚æ¬¡æ•°',
      value: formatNumber(data.request_count || 0),
      sub: `ç»Ÿè®¡å‘¨æœŸ: <span>${getPeriodLabel(currentPeriod)}</span>`
    },
    {
      icon: 'ğŸ“¥',
      iconClass: 'cyan',
      label: 'è¾“å…¥ Token',
      value: formatNumber(data.input_tokens || 0),
      sub: `å æ¯”: <span>${data.total_tokens ? ((data.input_tokens / data.total_tokens) * 100).toFixed(1) : 0}%</span>`
    },
    {
      icon: 'ğŸ“¤',
      iconClass: 'purple',
      label: 'è¾“å‡º Token',
      value: formatNumber(data.output_tokens || 0),
      sub: `å æ¯”: <span>${data.total_tokens ? ((data.output_tokens / data.total_tokens) * 100).toFixed(1) : 0}%</span>`
    },
    {
      icon: 'ğŸ’¾',
      iconClass: 'orange',
      label: 'ç¼“å­˜åˆ›å»º Token',
      value: formatNumber(data.cache_creation_input_tokens || 0),
      sub: 'é¦–æ¬¡ç¼“å­˜æ¶ˆè€—'
    },
    {
      icon: 'âš¡',
      iconClass: 'yellow',
      label: 'ç¼“å­˜è¯»å– Token',
      value: formatNumber(data.cache_read_input_tokens || 0),
      sub: 'ä»ç¼“å­˜è¯»å–'
    },
    {
      icon: 'ğŸ¯',
      iconClass: 'pink',
      label: 'ç¼“å­˜å‘½ä¸­ç‡',
      value: cacheHitRatio.toFixed(1) + '%',
      sub: `åˆ›å»º: <span>${formatNumber(data.cache_creation_input_tokens || 0)}</span> | è¯»å–: <span>${formatNumber(data.cache_read_input_tokens || 0)}</span>`
    }
  ];

  grid.innerHTML = cards.map(card => `
    <div class="stat-card">
      <div class="stat-icon ${card.iconClass}">${card.icon}</div>
      <div class="stat-content">
        <div class="stat-label">${card.label}</div>
        <div class="stat-value">${card.value}</div>
        <div class="stat-sub">${card.sub}</div>
      </div>
    </div>
  `).join('');
}

// è·å–å‘¨æœŸæ ‡ç­¾
function getPeriodLabel(period) {
  const labels = {
    'hour': 'æœ€è¿‘1å°æ—¶',
    'day': 'æœ€è¿‘24å°æ—¶',
    'week': 'æœ€è¿‘7å¤©',
    'month': 'æœ€è¿‘30å¤©',
    'all': 'å…¨éƒ¨æ—¶é—´'
  };
  return labels[period] || period;
}

// è·å–ä½¿ç”¨é‡æ•°æ®
async function fetchUsageData() {
  const btn = document.querySelector('.refresh-btn');
  btn.classList.add('loading');
  btn.disabled = true;

  try {
    const response = await fetch(`/v1/usage?period=${currentPeriod}`);
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    const data = await response.json();
    renderStats(data);
    
    // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
    const now = new Date();
    document.getElementById('last-update').textContent = 
      `ä¸Šæ¬¡æ›´æ–°: ${now.toLocaleTimeString('zh-CN')}`;
    
    // éšè—é”™è¯¯ä¿¡æ¯
    hideError();
  } catch (error) {
    console.error('è·å–æ•°æ®å¤±è´¥:', error);
    showError('è·å–æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•');
  } finally {
    btn.classList.remove('loading');
    btn.disabled = false;
  }
}

// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
function showError(message) {
  let errorEl = document.querySelector('.error-message');
  if (!errorEl) {
    errorEl = document.createElement('div');
    errorEl.className = 'error-message';
    document.querySelector('.header').after(errorEl);
  }
  errorEl.textContent = message;
  errorEl.classList.add('show');
}

// éšè—é”™è¯¯ä¿¡æ¯
function hideError() {
  const errorEl = document.querySelector('.error-message');
  if (errorEl) {
    errorEl.classList.remove('show');
  }
}

// åˆ·æ–°æ•°æ®
function refreshData() {
  fetchUsageData();
}

// è®¾ç½®è‡ªåŠ¨åˆ·æ–°
function setupAutoRefresh() {
  if (autoRefreshInterval) {
    clearInterval(autoRefreshInterval);
  }
  autoRefreshInterval = setInterval(fetchUsageData, 30000); // 30ç§’
}

// åˆå§‹åŒ–å‘¨æœŸé€‰æ‹©å™¨
function initPeriodSelector() {
  const buttons = document.querySelectorAll('.period-btn');
  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      buttons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentPeriod = btn.dataset.period;
      fetchUsageData();
    });
  });
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
  initPeriodSelector();
  fetchUsageData();
  setupAutoRefresh();
});
</script>
