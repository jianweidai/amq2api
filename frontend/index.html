<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <title>Admin ç®¡ç†æ§åˆ¶å°</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #f5f5f7;
      --panel: #ffffff;
      --text: #1d1d1f;
      --muted: #86868b;
      --accent: #0071e3;
      --accent-hover: #0077ed;
      --danger: #ff3b30;
      --success: #34c759;
      --warning: #ff9500;
      --border: #d2d2d7;
      --shadow: rgba(0, 0, 0, 0.08);
      --shadow-hover: rgba(0, 0, 0, 0.12);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #000000;
        --panel: #1c1c1e;
        --text: #f5f5f7;
        --muted: #98989d;
        --border: #38383a;
        --shadow: rgba(0, 0, 0, 0.3);
        --shadow-hover: rgba(0, 0, 0, 0.4);
      }
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
      line-height: 1.5;
      padding: 40px 20px;
    }

    .container {
      max-width: 980px;
      margin: 0 auto;
    }

    h1 {
      font-size: 48px;
      font-weight: 600;
      letter-spacing: -0.02em;
      margin-bottom: 8px;
    }

    h2 {
      font-size: 28px;
      font-weight: 600;
      margin: 32px 0 16px;
    }

    h3 {
      font-size: 20px;
      font-weight: 600;
      margin: 24px 0 12px;
    }

    .panel {
      background: var(--panel);
      border-radius: 18px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px var(--shadow);
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex: 1;
      min-width: 200px;
    }

    label {
      color: var(--muted);
      font-size: 13px;
      font-weight: 500;
    }

    input,
    textarea,
    select {
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
      transition: all 0.2s;
    }

    input:focus,
    textarea:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.1);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
      font-family: "SF Mono", Monaco, monospace;
    }

    button {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    button:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--muted);
    }

    .btn-secondary:hover {
      background: #6e6e73;
    }

    .btn-danger {
      background: var(--danger);
    }

    .btn-danger:hover {
      background: #ff453a;
    }

    .btn-warning {
      background: var(--warning);
    }

    .btn-warning:hover {
      background: #ffaa33;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .chip.success {
      color: var(--success);
      border-color: var(--success);
    }

    .chip.danger {
      color: var(--danger);
      border-color: var(--danger);
    }

    .chip.amazonq {
      color: #ff9900;
      border-color: #ff9900;
    }

    .chip.gemini {
      color: #4285f4;
      border-color: #4285f4;
    }

    .chip.custom_api {
      color: #9c27b0;
      border-color: #9c27b0;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
    }

    .card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px;
      transition: all 0.2s;
    }

    .card:hover {
      box-shadow: 0 4px 12px var(--shadow-hover);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 17px;
      font-weight: 600;
      flex: 1;
    }

    .kvs {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 8px 16px;
      font-size: 13px;
      margin: 12px 0;
    }

    .kvs .key {
      color: var(--muted);
    }

    .kvs .value {
      font-family: "SF Mono", Monaco, monospace;
      word-break: break-all;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 51px;
      height: 31px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--border);
      transition: 0.3s;
      border-radius: 31px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 27px;
      width: 27px;
      left: 2px;
      bottom: 2px;
      background: white;
      transition: 0.3s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    input:checked+.slider {
      background: var(--success);
    }

    input:checked+.slider:before {
      transform: translateX(20px);
    }

    .divider {
      height: 1px;
      background: var(--border);
      margin: 24px 0;
    }

    .mono {
      font-family: "SF Mono", Monaco, monospace;
    }

    /* è´¦å·é€‰æ‹©å¤é€‰æ¡†æ ·å¼ */
    .account-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--accent);
      flex-shrink: 0;
    }

    /* Tab åˆ‡æ¢æ ·å¼ */
    .tab-container {
      display: flex;
      gap: 4px;
      background: var(--panel);
      padding: 4px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .tab-btn {
      flex: 1;
      background: transparent;
      color: var(--muted);
      border: none;
      border-radius: 10px;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tab-btn:hover {
      color: var(--text);
      background: var(--bg);
    }

    .tab-btn.active {
      background: var(--accent);
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Token ç»Ÿè®¡å¡ç‰‡æ ·å¼ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-top: 16px;
    }

    @media (max-width: 900px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 600px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    .stat-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow-hover);
    }

    .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0;
    }

    .stat-icon.blue {
      background: rgba(0, 113, 227, 0.2);
    }

    .stat-icon.green {
      background: rgba(52, 199, 89, 0.2);
    }

    .stat-icon.purple {
      background: rgba(175, 82, 222, 0.2);
    }

    .stat-icon.pink {
      background: rgba(255, 45, 85, 0.2);
    }

    .stat-icon.cyan {
      background: rgba(90, 200, 250, 0.2);
    }

    .stat-icon.orange {
      background: rgba(255, 149, 0, 0.2);
    }

    .stat-icon.yellow {
      background: rgba(255, 204, 0, 0.2);
    }

    .stat-content {
      flex: 1;
      min-width: 0;
    }

    .stat-label {
      color: var(--muted);
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 600;
      letter-spacing: -0.02em;
      line-height: 1.2;
    }

    .stat-sub {
      color: var(--muted);
      font-size: 12px;
      margin-top: 4px;
    }

    .stat-sub span {
      color: var(--text);
      font-weight: 500;
    }

    .token-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .period-selector {
      display: flex;
      background: var(--bg);
      border-radius: 10px;
      padding: 4px;
      gap: 4px;
    }

    .period-btn {
      background: transparent;
      color: var(--muted);
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .period-btn:hover {
      color: var(--text);
      background: var(--panel);
    }

    .period-btn.active {
      background: var(--accent);
      color: white;
    }

    /* æ¨¡å‹æ˜ å°„æ ·å¼ */
    .mapping-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
    }

    .mapping-row input {
      flex: 1;
      min-width: 150px;
    }

    .mapping-arrow {
      color: var(--muted);
      font-size: 18px;
      flex-shrink: 0;
    }

    .mapping-delete {
      background: var(--danger);
      padding: 8px 12px;
      font-size: 12px;
      flex-shrink: 0;
    }

    .mapping-delete:hover {
      background: #ff453a;
    }

    /* ç™»å½•/è®¾ç½®é¡µé¢æ ·å¼ */
    .auth-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .auth-panel {
      background: var(--panel);
      border-radius: 24px;
      padding: 40px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 8px 32px var(--shadow);
    }

    .auth-panel h1 {
      font-size: 28px;
      margin-bottom: 8px;
      text-align: center;
    }

    .auth-panel .subtitle {
      color: var(--muted);
      text-align: center;
      margin-bottom: 32px;
      font-size: 14px;
    }

    .auth-panel .field {
      margin-bottom: 20px;
    }

    .auth-panel .field label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .auth-panel .field input {
      width: 100%;
      padding: 14px 16px;
      font-size: 15px;
    }

    .auth-panel .field .hint {
      color: var(--muted);
      font-size: 12px;
      margin-top: 6px;
    }

    .auth-panel .error-message {
      background: rgba(255, 59, 48, 0.1);
      color: var(--danger);
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 14px;
      margin-bottom: 20px;
      display: none;
    }

    .auth-panel .error-message.visible {
      display: block;
    }

    .auth-panel .lock-message {
      background: rgba(255, 149, 0, 0.1);
      color: var(--warning);
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 14px;
      margin-bottom: 20px;
      text-align: center;
    }

    .auth-panel button[type="submit"] {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      font-weight: 600;
      margin-top: 8px;
    }

    .auth-panel button[type="submit"]:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .auth-panel .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .auth-panel .divider {
      display: flex;
      align-items: center;
      margin: 24px 0;
    }

    .auth-panel .divider::before,
    .auth-panel .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .auth-panel .divider span {
      padding: 0 16px;
      color: var(--muted);
      font-size: 13px;
    }

    .auth-panel .admin-key-link {
      text-align: center;
      margin-top: 16px;
    }

    .auth-panel .admin-key-link a {
      color: var(--accent);
      text-decoration: none;
      font-size: 14px;
      cursor: pointer;
    }

    .auth-panel .admin-key-link a:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>
  <!-- ç™»å½•é¡µé¢ -->
  <div id="login-container" class="auth-container" style="display:none">
    <div class="auth-panel">
      <h1>ğŸ” ç®¡ç†å‘˜ç™»å½•</h1>
      <p class="subtitle">è¯·è¾“å…¥æ‚¨çš„ç®¡ç†å‘˜å‡­è¯</p>
      
      <div id="login-lock-message" class="lock-message" style="display:none"></div>
      <div id="login-error" class="error-message"></div>
      
      <form id="login-form" onsubmit="return handleLogin(event)">
        <div class="field">
          <label for="login-username">ç”¨æˆ·å</label>
          <input type="text" id="login-username" name="username" required autocomplete="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" />
        </div>
        <div class="field">
          <label for="login-password">å¯†ç </label>
          <input type="password" id="login-password" name="password" required autocomplete="current-password" placeholder="è¯·è¾“å…¥å¯†ç " />
        </div>
        <button type="submit" id="login-btn">ç™»å½•</button>
      </form>
    </div>
  </div>

  <!-- è®¾ç½®é¡µé¢ï¼ˆé¦–æ¬¡åˆ›å»ºç®¡ç†å‘˜è´¦å·ï¼‰ -->
  <div id="setup-container" class="auth-container" style="display:none">
    <div class="auth-panel">
      <h1>ğŸ‰ æ¬¢è¿ä½¿ç”¨</h1>
      <p class="subtitle">é¦–æ¬¡ä½¿ç”¨ï¼Œè¯·åˆ›å»ºç®¡ç†å‘˜è´¦å·</p>
      
      <div id="setup-error" class="error-message"></div>
      
      <form id="setup-form" onsubmit="return handleSetup(event)">
        <div class="field">
          <label for="setup-username">ç”¨æˆ·å</label>
          <input type="text" id="setup-username" name="username" required minlength="3" maxlength="50" autocomplete="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" />
          <div class="hint">3-50 ä¸ªå­—ç¬¦</div>
        </div>
        <div class="field">
          <label for="setup-password">å¯†ç </label>
          <input type="password" id="setup-password" name="password" required minlength="8" autocomplete="new-password" placeholder="è¯·è¾“å…¥å¯†ç " />
          <div class="hint">è‡³å°‘ 8 ä¸ªå­—ç¬¦</div>
        </div>
        <div class="field">
          <label for="setup-confirm">ç¡®è®¤å¯†ç </label>
          <input type="password" id="setup-confirm" name="confirmPassword" required minlength="8" autocomplete="new-password" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " />
        </div>
        <button type="submit" id="setup-btn">åˆ›å»ºè´¦å·</button>
      </form>
    </div>
  </div>

  <!-- ä¸»å†…å®¹åŒºåŸŸ -->
  <div id="main-container" class="container" style="display:none">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
      <h1>Admin ç®¡ç†</h1>
      <button onclick="logout()" class="btn-secondary" style="font-size: 14px;">ğŸšª é€€å‡ºç™»å½•</button>
    </div>
    <p style="color: var(--muted); margin-bottom: 32px;">ç®¡ç† Amazon Qã€Gemini å’Œ Custom API è´¦å·</p>

    <div class="panel">
      <h2>ç³»ç»ŸçŠ¶æ€</h2>
      <div class="row">
        <button onclick="checkHealth()">æ£€æŸ¥å¥åº·çŠ¶æ€</button>
        <div id="health" class="chip">æœªæ£€æµ‹</div>
      </div>
    </div>

    <!-- Tab åˆ‡æ¢ç»„ä»¶ -->
    <div class="tab-container">
      <button class="tab-btn active" data-tab="accounts" onclick="switchTab('accounts')">ğŸ“‹ è´¦å·ç®¡ç†</button>
      <button class="tab-btn" data-tab="tokens" onclick="switchTab('tokens')">ğŸ“Š Token ç®¡ç†</button>
    </div>

    <!-- è´¦å·ç®¡ç† Tab å†…å®¹ -->
    <div id="tab-accounts" class="tab-content active">
      <div class="panel">
        <h2>è´¦å·åˆ—è¡¨</h2>
        <div class="row">
          <button onclick="loadAccounts()">åˆ·æ–°åˆ—è¡¨</button>
          <select id="filter_type" onchange="applyFilters()" style="max-width:150px">
            <option value="all">å…¨éƒ¨ç±»å‹</option>
            <option value="amazonq">Amazon Q</option>
            <option value="gemini">Gemini</option>
            <option value="custom_api">Custom API</option>
          </select>
          <input id="filter_start_date" type="date" onchange="applyFilters()" placeholder="å¼€å§‹æ—¥æœŸ"
            style="max-width:150px" />
          <input id="filter_end_date" type="date" onchange="applyFilters()" placeholder="ç»“æŸæ—¥æœŸ"
            style="max-width:150px" />
          <button class="btn-secondary" onclick="clearFilters()">æ¸…é™¤ç­›é€‰</button>
          <button class="btn-danger" onclick="batchDelete()" id="batch_delete_btn" style="display:none">åˆ é™¤é€‰ä¸­</button>
          <button class="btn-warning" onclick="testSelectedAccounts()" id="test_selected_btn"
            style="display:none">æµ‹è¯•é€‰ä¸­</button>
          <button class="btn-warning" onclick="testAllAccounts()">æµ‹è¯•æ‰€æœ‰è´¦å·</button>
          <button class="btn-warning" onclick="refreshAllTokens()">æ‰¹é‡åˆ·æ–° Token</button>
          <input id="test_message" placeholder="æµ‹è¯•æ¶ˆæ¯" value="Hello" style="max-width:200px" />
          <div id="test_status" class="chip" style="display:none"></div>
        </div>
        <div id="test_results" style="margin-top:12px"></div>
        <div class="row" style="margin-top:12px;align-items:center">
          <input id="select_all" type="checkbox" class="account-checkbox" onchange="toggleSelectAll()" />
          <label for="select_all" style="color: var(--text);cursor:pointer">å…¨é€‰</label>
          <span id="selected_count" style="color: var(--muted); margin-left: 12px;">å·²é€‰æ‹©: 0</span>
        </div>
        <div class="list" id="accounts"></div>

        <div class="divider"></div>

        <h3>åˆ›å»ºæ–°è´¦å·</h3>
        <div class="row">
          <div class="field" style="max-width:200px">
            <label>è´¦å·ç±»å‹</label>
            <select id="new_type" onchange="toggleAccountFields()">
              <option value="amazonq">Amazon Q</option>
              <option value="gemini">Gemini</option>
              <option value="custom_api">Custom API</option>
            </select>
          </div>
          <div class="field">
            <label>æ ‡ç­¾</label>
            <input id="new_label" placeholder="è´¦å·æ ‡ç­¾" />
          </div>
        </div>
        <div class="row">
          <div class="field">
            <label>Client ID</label>
            <input id="new_clientId" />
          </div>
          <div class="field">
            <label>Client Secret</label>
            <input id="new_clientSecret" type="password" />
          </div>
        </div>
        <div class="row">
          <div class="field">
            <label>Refresh Token</label>
            <input id="new_refreshToken" type="password" />
          </div>
          <div class="field">
            <label>Access Token (å¯é€‰)</label>
            <input id="new_accessToken" type="password" />
          </div>
        </div>
        <div id="gemini_fields" style="display:none">
          <div class="row">
            <div class="field">
              <label>Project ID (å¯é€‰)</label>
              <input id="new_project" placeholder="Gemini é¡¹ç›® ID" />
            </div>
            <div class="field">
              <label>API Endpoint (å¯é€‰)</label>
              <input id="new_api_endpoint" placeholder="https://daily-cloudcode-pa.sandbox.googleapis.com" />
            </div>
          </div>
        </div>
        <div id="custom_api_fields" style="display:none">
          <div class="row">
            <div class="field">
              <label>API Base URL</label>
              <input id="new_api_base" placeholder="https://api.openai.com/v1" />
            </div>
            <div class="field">
              <label>Model</label>
              <input id="new_model" placeholder="gpt-4o" />
            </div>
          </div>
          <div class="row">
            <div class="field" style="max-width:150px">
              <label>API Format</label>
              <select id="new_format">
                <option value="openai">OpenAI</option>
                <option value="claude">Claude</option>
              </select>
            </div>
            <div class="field" style="max-width:200px">
              <label>Providerï¼ˆæä¾›å•†ï¼‰</label>
              <select id="new_provider">
                <option value="">é»˜è®¤ï¼ˆå®˜æ–¹ APIï¼‰</option>
                <option value="azure">Azureï¼ˆAzure Foundryï¼‰</option>
                <option value="anthropic">Anthropicï¼ˆå®˜æ–¹ï¼‰</option>
                <option value="openai">OpenAI</option>
                <option value="other">å…¶ä»–</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- æ¨¡å‹æ˜ å°„é…ç½®åŒºåŸŸ -->
        <div id="model_mapping_section" style="margin-top:20px">
          <h3>ğŸ”„ æ¨¡å‹æ˜ å°„ï¼ˆå¯é€‰ï¼‰</h3>
          <p style="color: var(--muted); font-size: 13px; margin-bottom: 12px;">
            é…ç½®æ¨¡å‹æ˜ å°„å…³ç³»ã€‚å·¦ä¾§æ˜¯å®¢æˆ·ç«¯è¯·æ±‚çš„æ¨¡å‹ï¼Œå³ä¾§æ˜¯å®é™…å‘é€ç»™APIçš„æ¨¡å‹ã€‚
          </p>
          
          <!-- å¿«æ·æ·»åŠ æŒ‰é’® -->
          <div class="row" style="margin-bottom:12px">
            <button type="button" class="btn-secondary" onclick="addQuickMapping('claude-sonnet-4-5-20250929', 'claude-sonnet-4-5')">+ Sonnet 4.5</button>
            <button type="button" class="btn-secondary" onclick="addQuickMapping('claude-haiku-4-5-20251001', 'claude-haiku-4-5')">+ Haiku 4.5</button>
            <button type="button" class="btn-secondary" onclick="addQuickMapping('claude-opus-4-5-20251101', 'claude-opus-4-5')">+ Opus 4.5</button>
          </div>
          
          <!-- æ˜ å°„åˆ—è¡¨å®¹å™¨ -->
          <div id="mapping_list" style="display:flex;flex-direction:column;gap:8px;margin-bottom:12px"></div>
          
          <!-- æ·»åŠ æ˜ å°„æŒ‰é’® -->
          <button type="button" class="btn-secondary" onclick="addMappingRow()">â• æ·»åŠ æ¨¡å‹æ˜ å°„</button>
        </div>
        
        <div class="row" style="margin-top:12px;align-items:center">
          <label class="switch">
            <input id="new_enabled" type="checkbox" checked />
            <span class="slider"></span>
          </label>
          <label style="color: var(--text)">å¯ç”¨è´¦å·</label>
          <div class="field" style="max-width:120px;margin-left:16px">
            <label>æƒé‡</label>
            <input id="new_weight" type="number" min="1" max="100" value="50" placeholder="50" />
          </div>
          <button onclick="createAccount()">åˆ›å»ºè´¦å·</button>
        </div>

        <div class="divider"></div>

        <h3>æ‰¹é‡å¯¼å…¥</h3>
        <div class="row">
          <div class="field" style="max-width:200px">
            <label>å¯¼å…¥ç±»å‹</label>
            <select id="import_type" onchange="toggleImportFormat()">
              <option value="full">å®Œæ•´æ ¼å¼</option>
              <option value="amazonq">Amazon Q ç®€åŒ–</option>
              <option value="gemini">Gemini ç®€åŒ–</option>
            </select>
          </div>
        </div>
        <div class="field">
          <label
            id="import_format_label">è´¦å·æ•°æ®ï¼ˆæ¯è¡Œæ ¼å¼ï¼štype|label|clientId|clientSecret|refreshToken|accessToken|project|api_endpointï¼‰</label>
          <textarea id="import_data"
            placeholder="amazonq|æˆ‘çš„è´¦å·|client_id|client_secret|refresh_token|access_token||"></textarea>
        </div>
        <div class="row">
          <button onclick="importAccounts()">æ‰¹é‡å¯¼å…¥</button>
          <button class="btn-secondary" onclick="exportAccounts()">å¯¼å‡ºæ‰€æœ‰è´¦å·</button>
          <button class="btn-secondary" onclick="exportAccounts(true)" id="export_selected_btn" style="display:none">å¯¼å‡ºé€‰ä¸­</button>
          <div id="import_status" class="chip" style="display:none"></div>
        </div>

        <div class="divider"></div>

        <h3>ğŸ”— URL ç™»å½•ï¼ˆè‡ªåŠ¨åˆ›å»º Amazon Q è´¦å·ï¼‰</h3>
        <p style="color: var(--muted); font-size: 13px; margin-bottom: 12px;">
          é€šè¿‡ AWS è®¾å¤‡æˆæƒæµç¨‹è‡ªåŠ¨è·å–å‡­è¯å¹¶åˆ›å»ºè´¦å·ï¼Œæ— éœ€æ‰‹åŠ¨å¡«å†™ Client IDã€Secret ç­‰ä¿¡æ¯ã€‚è¶…æ—¶æ—¶é—´ï¼š5åˆ†é’Ÿã€‚
        </p>
        <div class="row">
          <div class="field">
            <label>è´¦å·æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰</label>
            <input id="auth_label" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„ Amazon Q è´¦å·" />
          </div>
          <div class="field" style="max-width:150px">
            <label>å¯ç”¨è´¦å·</label>
            <div style="padding-top:6px">
              <label class="switch">
                <input id="auth_enabled" type="checkbox" checked />
                <span class="slider"></span>
              </label>
            </div>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button onclick="startAuth()">ğŸš€ å¼€å§‹ç™»å½•</button>
          <button class="btn-secondary" onclick="claimAuth()">â³ ç­‰å¾…æˆæƒå¹¶åˆ›å»ºè´¦å·</button>
        </div>
        <div class="field" style="margin-top:12px">
          <label>ç™»å½•çŠ¶æ€</label>
          <pre id="auth_info" style="background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px;font-family:'SF Mono',Monaco,monospace;font-size:13px;white-space:pre-wrap;word-break:break-all;min-height:80px;max-height:200px;overflow-y:auto;">å°šæœªå¼€å§‹ç™»å½•</pre>
        </div>
      </div>
    </div> <!-- å…³é—­ tab-accounts -->

    <!-- Token ç®¡ç† Tab å†…å®¹ -->
    <div id="tab-tokens" class="tab-content">
      <div class="panel">
        <div class="token-header">
          <div>
            <h2 style="margin:0">ğŸ“Š Token ä½¿ç”¨ç»Ÿè®¡</h2>
            <p id="last-update" style="color:var(--muted);font-size:13px;margin-top:4px">ä¸Šæ¬¡æ›´æ–°: --</p>
          </div>
          <div style="display:flex;gap:12px;align-items:center">
            <div class="period-selector">
              <button class="period-btn" data-period="hour">å°æ—¶</button>
              <button class="period-btn active" data-period="day">ä»Šæ—¥</button>
              <button class="period-btn" data-period="week">æœ¬å‘¨</button>
              <button class="period-btn" data-period="month">æœ¬æœˆ</button>
              <button class="period-btn" data-period="all">å…¨éƒ¨</button>
            </div>
            <button onclick="refreshTokenData()" class="btn-secondary">ğŸ”„ åˆ·æ–°</button>
          </div>
        </div>
        <div class="stats-grid" id="stats-grid">
          <!-- ç»Ÿè®¡å¡ç‰‡ç”± JavaScript æ¸²æŸ“ -->
        </div>
      </div>
    </div> <!-- å…³é—­ tab-tokens -->
  </div> <!-- å…³é—­ main-container -->

  <script>
    // ==================== è®¤è¯çŠ¶æ€ç®¡ç† ====================
    
    // è·å–ä¼šè¯ä»¤ç‰Œ
    function getSessionToken() {
      return sessionStorage.getItem('sessionToken');
    }

    // åˆ›å»ºå¸¦è®¤è¯å¤´çš„ fetch è¯·æ±‚
    function authFetch(url, options = {}) {
      const sessionToken = getSessionToken();
      
      if (!sessionToken) {
        return Promise.reject(new Error('æœªç™»å½•'));
      }
      
      const headers = options.headers || {};
      headers['X-Session-Token'] = sessionToken;
      
      return fetch(url, { ...options, headers })
        .then(response => {
          // å¦‚æœè¿”å› 401 æˆ– 403ï¼Œå¯èƒ½æ˜¯ä¼šè¯è¿‡æœŸ
          if (response.status === 401 || response.status === 403) {
            sessionStorage.removeItem('sessionToken');
            showLoginPage('ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
            throw new Error('è®¤è¯å¤±è´¥');
          }
          return response;
        });
    }

    // ==================== é¡µé¢æ˜¾ç¤ºæ§åˆ¶ ====================
    
    function showLoginPage(errorMessage = null) {
      document.getElementById('login-container').style.display = 'flex';
      document.getElementById('setup-container').style.display = 'none';
      document.getElementById('main-container').style.display = 'none';
      
      if (errorMessage) {
        showLoginError(errorMessage);
      } else {
        hideLoginError();
      }
      
      // èšç„¦ç”¨æˆ·åè¾“å…¥æ¡†
      setTimeout(() => {
        document.getElementById('login-username').focus();
      }, 100);
    }

    function showSetupPage(errorMessage = null) {
      document.getElementById('login-container').style.display = 'none';
      document.getElementById('setup-container').style.display = 'flex';
      document.getElementById('main-container').style.display = 'none';
      
      if (errorMessage) {
        showSetupError(errorMessage);
      } else {
        hideSetupError();
      }
      
      // èšç„¦ç”¨æˆ·åè¾“å…¥æ¡†
      setTimeout(() => {
        document.getElementById('setup-username').focus();
      }, 100);
    }

    function showAdminPanel() {
      document.getElementById('login-container').style.display = 'none';
      document.getElementById('setup-container').style.display = 'none';
      document.getElementById('main-container').style.display = 'block';
      
      // åŠ è½½è´¦å·åˆ—è¡¨
      loadAccounts();
    }

    // ==================== é”™è¯¯æ¶ˆæ¯æ˜¾ç¤º ====================
    
    function showLoginError(message) {
      const el = document.getElementById('login-error');
      el.textContent = message;
      el.classList.add('visible');
    }

    function hideLoginError() {
      const el = document.getElementById('login-error');
      el.textContent = '';
      el.classList.remove('visible');
    }

    function showSetupError(message) {
      const el = document.getElementById('setup-error');
      el.textContent = message;
      el.classList.add('visible');
    }

    function hideSetupError() {
      const el = document.getElementById('setup-error');
      el.textContent = '';
      el.classList.remove('visible');
    }

    function showLockMessage(seconds) {
      const el = document.getElementById('login-lock-message');
      el.textContent = `è´¦å·å·²é”å®šï¼Œè¯· ${seconds} ç§’åé‡è¯•`;
      el.style.display = 'block';
      
      // å€’è®¡æ—¶æ›´æ–°
      const interval = setInterval(() => {
        seconds--;
        if (seconds <= 0) {
          el.style.display = 'none';
          clearInterval(interval);
        } else {
          el.textContent = `è´¦å·å·²é”å®šï¼Œè¯· ${seconds} ç§’åé‡è¯•`;
        }
      }, 1000);
    }

    // ==================== åˆå§‹åŒ–è®¤è¯ ====================
    
    async function initAuth() {
      try {
        // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        const response = await fetch('/api/admin/status');
        const data = await response.json();
        
        if (data.needSetup) {
          // éœ€è¦é¦–æ¬¡è®¾ç½®
          showSetupPage();
          return;
        }
        
        if (data.locked) {
          // è´¦å·è¢«é”å®š
          showLoginPage();
          showLockMessage(data.lockRemaining);
          return;
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆä¼šè¯
        const sessionToken = getSessionToken();
        
        if (sessionToken) {
          // éªŒè¯ä¼šè¯ä»¤ç‰Œ
          const valid = await validateSession(sessionToken);
          if (valid) {
            showAdminPanel();
            return;
          }
          // ä¼šè¯æ— æ•ˆï¼Œæ¸…é™¤
          sessionStorage.removeItem('sessionToken');
        }
        
        // æ˜¾ç¤ºç™»å½•é¡µé¢
        showLoginPage();
      } catch (error) {
        console.error('åˆå§‹åŒ–è®¤è¯å¤±è´¥:', error);
        showLoginPage('ç³»ç»Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
      }
    }

    // éªŒè¯ä¼šè¯ä»¤ç‰Œ
    async function validateSession(token) {
      try {
        const response = await fetch('/v2/accounts', {
          headers: { 'X-Session-Token': token }
        });
        return response.ok;
      } catch (e) {
        return false;
      }
    }

    // ==================== ç™»å½•å¤„ç† ====================
    
    async function handleLogin(event) {
      event.preventDefault();
      
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      const btn = document.getElementById('login-btn');
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span>ç™»å½•ä¸­...';
      hideLoginError();
      
      try {
        const response = await fetch('/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        
        const data = await response.json();
        
        if (data.success && data.token) {
          // ç™»å½•æˆåŠŸ
          sessionStorage.setItem('sessionToken', data.token);
          showAdminPanel();
        } else {
          // ç™»å½•å¤±è´¥
          if (data.lockRemaining) {
            showLockMessage(data.lockRemaining);
          }
          showLoginError(data.message || 'ç™»å½•å¤±è´¥');
        }
      } catch (error) {
        console.error('ç™»å½•é”™è¯¯:', error);
        showLoginError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
      } finally {
        btn.disabled = false;
        btn.textContent = 'ç™»å½•';
      }
      
      return false;
    }

    // ==================== è®¾ç½®å¤„ç† ====================
    
    async function handleSetup(event) {
      event.preventDefault();
      
      const username = document.getElementById('setup-username').value.trim();
      const password = document.getElementById('setup-password').value;
      const confirmPassword = document.getElementById('setup-confirm').value;
      const btn = document.getElementById('setup-btn');
      
      // å‰ç«¯éªŒè¯
      if (username.length < 3 || username.length > 50) {
        showSetupError('ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨ 3-50 ä¸ªå­—ç¬¦ä¹‹é—´');
        return false;
      }
      
      if (password.length < 8) {
        showSetupError('å¯†ç é•¿åº¦è‡³å°‘ 8 ä¸ªå­—ç¬¦');
        return false;
      }
      
      if (password !== confirmPassword) {
        showSetupError('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
        return false;
      }
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span>åˆ›å»ºä¸­...';
      hideSetupError();
      
      try {
        const response = await fetch('/api/admin/setup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password, confirmPassword })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // åˆ›å»ºæˆåŠŸï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
          showLoginPage();
          // æ˜¾ç¤ºæˆåŠŸæç¤º
          alert('ç®¡ç†å‘˜è´¦å·åˆ›å»ºæˆåŠŸï¼Œè¯·ç™»å½•');
        } else {
          showSetupError(data.message || 'åˆ›å»ºå¤±è´¥');
        }
      } catch (error) {
        console.error('è®¾ç½®é”™è¯¯:', error);
        showSetupError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
      } finally {
        btn.disabled = false;
        btn.textContent = 'åˆ›å»ºè´¦å·';
      }
      
      return false;
    }

    // ==================== ç™»å‡ºå¤„ç† ====================
    
    async function logout() {
      const sessionToken = getSessionToken();
      
      if (sessionToken) {
        try {
          await fetch('/api/admin/logout', {
            method: 'POST',
            headers: { 'X-Session-Token': sessionToken }
          });
        } catch (e) {
          console.error('ç™»å‡ºè¯·æ±‚å¤±è´¥:', e);
        }
      }
      
      // æ¸…é™¤æœ¬åœ°å­˜å‚¨
      sessionStorage.removeItem('sessionToken');
      sessionStorage.removeItem('adminKey');
      
      // æ˜¾ç¤ºç™»å½•é¡µé¢
      showLoginPage();
    }

    // ==================== å®æ—¶è¡¨å•éªŒè¯ ====================
    
    // è®¾ç½®é¡µé¢å®æ—¶éªŒè¯
    function setupFormValidation() {
      const usernameInput = document.getElementById('setup-username');
      const passwordInput = document.getElementById('setup-password');
      const confirmInput = document.getElementById('setup-confirm');
      
      // ç”¨æˆ·åéªŒè¯
      usernameInput.addEventListener('input', function() {
        const value = this.value.trim();
        if (value.length > 0 && (value.length < 3 || value.length > 50)) {
          this.style.borderColor = 'var(--danger)';
        } else {
          this.style.borderColor = '';
        }
      });
      
      // å¯†ç éªŒè¯
      passwordInput.addEventListener('input', function() {
        const value = this.value;
        if (value.length > 0 && value.length < 8) {
          this.style.borderColor = 'var(--danger)';
        } else {
          this.style.borderColor = '';
        }
        // åŒæ—¶æ£€æŸ¥ç¡®è®¤å¯†ç 
        validatePasswordMatch();
      });
      
      // ç¡®è®¤å¯†ç éªŒè¯
      confirmInput.addEventListener('input', validatePasswordMatch);
      
      function validatePasswordMatch() {
        const password = passwordInput.value;
        const confirm = confirmInput.value;
        if (confirm.length > 0 && password !== confirm) {
          confirmInput.style.borderColor = 'var(--danger)';
        } else {
          confirmInput.style.borderColor = '';
        }
      }
    }

    // ç™»å½•é¡µé¢é”®ç›˜æ”¯æŒ
    function setupLoginKeyboardSupport() {
      const loginForm = document.getElementById('login-form');
      const setupForm = document.getElementById('setup-form');
      
      // Enter é”®æäº¤è¡¨å•
      document.getElementById('login-password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          loginForm.dispatchEvent(new Event('submit'));
        }
      });
      
      document.getElementById('setup-confirm').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          setupForm.dispatchEvent(new Event('submit'));
        }
      });
    }

    function toggleAccountFields() {
      const type = document.getElementById('new_type').value;
      document.getElementById('gemini_fields').style.display = type === 'gemini' ? 'block' : 'none';
      document.getElementById('custom_api_fields').style.display = type === 'custom_api' ? 'block' : 'none';

      // Show/hide standard OAuth fields based on account type
      const clientIdField = document.getElementById('new_clientId').closest('.field');
      const refreshTokenField = document.getElementById('new_refreshToken').closest('.field');
      const accessTokenField = document.getElementById('new_accessToken').closest('.field');

      if (type === 'custom_api') {
        // For custom_api, clientSecret is the API Key, hide other OAuth fields
        clientIdField.style.display = 'none';
        refreshTokenField.style.display = 'none';
        accessTokenField.style.display = 'none';
        document.getElementById('new_clientSecret').closest('.field').querySelector('label').textContent = 'API Key';
      } else {
        clientIdField.style.display = 'flex';
        refreshTokenField.style.display = 'flex';
        accessTokenField.style.display = 'flex';
        document.getElementById('new_clientSecret').closest('.field').querySelector('label').textContent = 'Client Secret';
      }
    }

    function toggleImportFormat() {
      const type = document.getElementById('import_type').value;
      const label = document.getElementById('import_format_label');
      const textarea = document.getElementById('import_data');

      if (type === 'amazonq') {
        label.textContent = 'è´¦å·æ•°æ®ï¼ˆæ¯è¡Œæ ¼å¼ï¼šemail|password|clientId|clientSecret|refreshToken|accessTokenï¼‰';
        textarea.placeholder = 'user@example.com|password|client_id|client_secret|refresh_token|access_token';
      } else if (type === 'gemini') {
        label.textContent = 'è´¦å·æ•°æ®ï¼ˆæ¯è¡Œæ ¼å¼ï¼šlabel|clientId|clientSecret|refreshToken|accessToken|project|api_endpointï¼‰';
        textarea.placeholder = 'æˆ‘çš„è´¦å·|client_id|client_secret|refresh_token|access_token|project_id|api_endpoint';
      } else {
        label.textContent = 'è´¦å·æ•°æ®ï¼ˆæ–°æ ¼å¼ï¼štype|label|clientId|clientSecret|refreshToken|accessToken|project|api_endpoint|weight|rate_limit|other_jsonï¼Œå…¼å®¹æ—§æ ¼å¼ï¼‰';
        textarea.placeholder = 'amazonq|æˆ‘çš„è´¦å·|client_id|client_secret|refresh_token|access_token|||50|20|{}';
      }
    }

    // ============== æ¨¡å‹æ˜ å°„ç®¡ç†å‡½æ•° ==============
    
    // å­˜å‚¨å½“å‰çš„æ˜ å°„åˆ—è¡¨
    let currentMappings = [];

    function renderMappingList(mappings) {
      const container = document.getElementById('mapping_list');
      container.innerHTML = '';
      
      if (!mappings || mappings.length === 0) {
        return;
      }
      
      mappings.forEach((mapping, index) => {
        const row = document.createElement('div');
        row.className = 'mapping-row';
        
        const requestInput = document.createElement('input');
        requestInput.type = 'text';
        requestInput.placeholder = 'è¯·æ±‚æ¨¡å‹ï¼ˆå¦‚ claude-sonnet-4-5-20250929ï¼‰';
        requestInput.value = mapping.requestModel || '';
        requestInput.oninput = () => {
          currentMappings[index].requestModel = requestInput.value.trim();
        };
        
        const arrow = document.createElement('span');
        arrow.className = 'mapping-arrow';
        arrow.textContent = 'â†’';
        
        const targetInput = document.createElement('input');
        targetInput.type = 'text';
        targetInput.placeholder = 'ç›®æ ‡æ¨¡å‹ï¼ˆå¦‚ claude-sonnet-4-5ï¼‰';
        targetInput.value = mapping.targetModel || '';
        targetInput.oninput = () => {
          currentMappings[index].targetModel = targetInput.value.trim();
        };
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'mapping-delete';
        deleteBtn.textContent = 'ğŸ—‘ï¸ åˆ é™¤';
        deleteBtn.onclick = () => removeMappingRow(index);
        
        row.appendChild(requestInput);
        row.appendChild(arrow);
        row.appendChild(targetInput);
        row.appendChild(deleteBtn);
        
        container.appendChild(row);
      });
    }

    function addMappingRow() {
      currentMappings.push({ requestModel: '', targetModel: '' });
      // Check if we're in edit modal or create form
      const editContainer = document.getElementById('edit_mapping_list');
      if (editContainer) {
        renderEditMappingList();
      } else {
        renderMappingList(currentMappings);
      }
    }

    function addQuickMapping(requestModel, targetModel) {
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„è¯·æ±‚æ¨¡å‹
      const exists = currentMappings.some(m => m.requestModel === requestModel);
      if (exists) {
        alert(`æ˜ å°„ "${requestModel}" å·²å­˜åœ¨`);
        return;
      }
      
      currentMappings.push({ requestModel, targetModel });
      // Check if we're in edit modal or create form
      const editContainer = document.getElementById('edit_mapping_list');
      if (editContainer) {
        renderEditMappingList();
      } else {
        renderMappingList(currentMappings);
      }
    }

    function removeMappingRow(index) {
      currentMappings.splice(index, 1);
      renderMappingList(currentMappings);
    }

    function getMappingsFromUI() {
      // Filter out empty mappings
      return currentMappings.filter(m => 
        m.requestModel && m.requestModel.trim() !== '' && 
        m.targetModel && m.targetModel.trim() !== ''
      );
    }

    function validateMappings(mappings) {
      if (!mappings || mappings.length === 0) {
        return { valid: true, error: null };
      }
      
      // Check for duplicate request models
      const requestModels = mappings.map(m => m.requestModel);
      const duplicates = requestModels.filter((item, index) => requestModels.indexOf(item) !== index);
      
      if (duplicates.length > 0) {
        return { 
          valid: false, 
          error: `æ£€æµ‹åˆ°é‡å¤çš„è¯·æ±‚æ¨¡å‹: ${duplicates.join(', ')}` 
        };
      }
      
      return { valid: true, error: null };
    }

    function renderEditMappingList() {
      const container = document.getElementById('edit_mapping_list');
      if (!container) return;
      
      container.innerHTML = '';
      
      if (!currentMappings || currentMappings.length === 0) {
        return;
      }
      
      currentMappings.forEach((mapping, index) => {
        const row = document.createElement('div');
        row.style.cssText = 'display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:8px';
        
        const requestInput = document.createElement('input');
        requestInput.type = 'text';
        requestInput.placeholder = 'è¯·æ±‚æ¨¡å‹';
        requestInput.value = mapping.requestModel || '';
        requestInput.style.cssText = 'flex:1;min-width:120px;padding:6px 8px;border-radius:6px;border:1px solid var(--border);background:var(--panel);color:var(--text);font-size:12px';
        requestInput.oninput = () => {
          currentMappings[index].requestModel = requestInput.value.trim();
        };
        
        const arrow = document.createElement('span');
        arrow.textContent = 'â†’';
        arrow.style.cssText = 'color:var(--muted);font-size:14px;flex-shrink:0';
        
        const targetInput = document.createElement('input');
        targetInput.type = 'text';
        targetInput.placeholder = 'ç›®æ ‡æ¨¡å‹';
        targetInput.value = mapping.targetModel || '';
        targetInput.style.cssText = 'flex:1;min-width:120px;padding:6px 8px;border-radius:6px;border:1px solid var(--border);background:var(--panel);color:var(--text);font-size:12px';
        targetInput.oninput = () => {
          currentMappings[index].targetModel = targetInput.value.trim();
        };
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'ğŸ—‘ï¸';
        deleteBtn.style.cssText = 'padding:6px 10px;border-radius:6px;border:none;background:var(--danger);color:white;cursor:pointer;font-size:12px;flex-shrink:0';
        deleteBtn.onclick = () => {
          currentMappings.splice(index, 1);
          renderEditMappingList();
        };
        
        row.appendChild(requestInput);
        row.appendChild(arrow);
        row.appendChild(targetInput);
        row.appendChild(deleteBtn);
        
        container.appendChild(row);
      });
    }

    // ============== ç»“æŸæ¨¡å‹æ˜ å°„ç®¡ç†å‡½æ•° ==============

    function setHealth(text, ok = true) {
      const el = document.getElementById('health');
      el.textContent = text;
      el.className = ok ? 'chip success' : 'chip danger';
    }

    async function checkHealth() {
      try {
        const r = await fetch('/health');
        const j = await r.json();
        if (j && j.status === 'healthy') {
          setHealth(`å¥åº· (${j.enabled_accounts} ä¸ªå¯ç”¨è´¦å·)`, true);
        } else {
          setHealth('ä¸å¥åº·', false);
        }
      } catch (e) {
        setHealth('é”™è¯¯', false);
      }
    }

    let allAccounts = [];
    let selectedIds = new Set();

    function renderAccounts(list) {
      const root = document.getElementById('accounts');
      root.innerHTML = '';
      if (!Array.isArray(list) || list.length === 0) {
        root.innerHTML = '<p style="color: var(--muted)">æš‚æ— è´¦å·</p>';
        return;
      }
      for (const acc of list) {
        const card = document.createElement('div');
        card.className = 'card';

        const header = document.createElement('div');
        header.className = 'card-header';

        const selectChk = document.createElement('input');
        selectChk.type = 'checkbox';
        selectChk.className = 'account-checkbox';
        selectChk.checked = selectedIds.has(acc.id);
        selectChk.onchange = () => {
          if (selectChk.checked) {
            selectedIds.add(acc.id);
          } else {
            selectedIds.delete(acc.id);
          }
          updateSelectedCount();
        };

        const title = document.createElement('div');
        title.className = 'card-title';
        title.textContent = acc.label || '(æ— æ ‡ç­¾)';

        const typeChip = document.createElement('span');
        typeChip.className = `chip ${acc.type || 'amazonq'}`;
        typeChip.textContent = acc.type === 'gemini' ? 'Gemini' : (acc.type === 'custom_api' ? 'ğŸ”Œ Custom API' : 'Amazon Q');

        const idChip = document.createElement('span');
        idChip.className = 'chip mono';
        idChip.textContent = acc.id.substring(0, 8);

        const toggleWrap = document.createElement('label');
        toggleWrap.className = 'switch';
        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.checked = !!acc.enabled;
        chk.onchange = async () => {
          try {
            await updateAccount(acc.id, { enabled: chk.checked });
          } catch (e) {
            chk.checked = !chk.checked;
          }
        };
        const slider = document.createElement('span');
        slider.className = 'slider';
        toggleWrap.appendChild(chk);
        toggleWrap.appendChild(slider);

        header.appendChild(selectChk);
        header.appendChild(title);
        header.appendChild(typeChip);
        header.appendChild(idChip);
        header.appendChild(toggleWrap);
        card.appendChild(header);

        const meta = document.createElement('div');
        meta.className = 'kvs';
        function row(k, v) {
          const kEl = document.createElement('div');
          kEl.className = 'key';
          kEl.textContent = k;
          const vEl = document.createElement('div');
          vEl.className = 'value';
          vEl.textContent = v ?? '';
          meta.appendChild(kEl);
          meta.appendChild(vEl);
        }

        const other = acc.other || {};
        if (other.suspended) {
          row('çŠ¶æ€', 'âš ï¸ å·²è¢«å°ç¦');
          row('å°ç¦æ—¶é—´', other.suspended_at || 'N/A');
        }
        row('æƒé‡', `${acc.weight || 50}ï¼ˆè¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼Œå»ºè®®1-100ï¼‰`);
        row('åˆ›å»ºæ—¶é—´', acc.created_at || 'N/A');
        if (acc.type === 'custom_api') {
          row('API Base', other.api_base || 'N/A');
          row('Model', other.model || 'N/A');
          row('Format', other.format === 'claude' ? 'Claude' : 'OpenAI');
        } else {
          row('åˆ·æ–°çŠ¶æ€', acc.last_refresh_status || 'never');
          row('åˆ·æ–°æ—¶é—´', acc.last_refresh_time || 'N/A');
          row('Client ID', acc.clientId);
          // Refresh Token æ˜¾ç¤ºï¼ˆå¸¦æ˜¾ç¤º/éšè—åŠŸèƒ½ï¼‰
          const rtKey = document.createElement('div');
          rtKey.className = 'key';
          rtKey.textContent = 'Refresh Token';
          const rtVal = document.createElement('div');
          rtVal.className = 'value';
          rtVal.style.display = 'flex';
          rtVal.style.alignItems = 'center';
          rtVal.style.gap = '8px';
          const rtText = document.createElement('span');
          rtText.textContent = acc.refreshToken ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : 'N/A';
          rtText.style.flex = '1';
          rtText.style.wordBreak = 'break-all';
          const rtToggle = document.createElement('button');
          rtToggle.textContent = 'ğŸ‘';
          rtToggle.style.cssText = 'padding:4px 8px;font-size:12px;background:var(--muted);border-radius:6px;flex-shrink:0';
          rtToggle.title = 'æ˜¾ç¤º/éšè—';
          let rtVisible = false;
          rtToggle.onclick = () => {
            rtVisible = !rtVisible;
            rtText.textContent = rtVisible ? (acc.refreshToken || 'N/A') : (acc.refreshToken ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : 'N/A');
            rtToggle.textContent = rtVisible ? 'ğŸ™ˆ' : 'ğŸ‘';
          };
          if (acc.refreshToken) {
            const rtCopy = document.createElement('button');
            rtCopy.textContent = 'ğŸ“‹';
            rtCopy.style.cssText = 'padding:4px 8px;font-size:12px;background:var(--muted);border-radius:6px;flex-shrink:0';
            rtCopy.title = 'å¤åˆ¶';
            rtCopy.onclick = () => {
              navigator.clipboard.writeText(acc.refreshToken).then(() => {
                rtCopy.textContent = 'âœ“';
                setTimeout(() => rtCopy.textContent = 'ğŸ“‹', 1500);
              });
            };
            rtVal.appendChild(rtText);
            rtVal.appendChild(rtToggle);
            rtVal.appendChild(rtCopy);
          } else {
            rtVal.appendChild(rtText);
          }
          meta.appendChild(rtKey);
          meta.appendChild(rtVal);
          if (acc.type === 'gemini' && other.project) {
            row('Project ID', other.project);
          }
        }
        card.appendChild(meta);

        const actions = document.createElement('div');
        actions.className = 'row';
        actions.style.marginTop = '16px';

        const testBtn = document.createElement('button');
        testBtn.className = 'btn-secondary';
        testBtn.textContent = 'æµ‹è¯•';
        testBtn.onclick = () => testSingleAccount(acc.id);
        actions.appendChild(testBtn);

        if (acc.type !== 'custom_api') {
          const refreshBtn = document.createElement('button');
          refreshBtn.className = 'btn-warning';
          refreshBtn.textContent = 'åˆ·æ–°Token';
          refreshBtn.onclick = () => refreshAccount(acc.id);
          actions.appendChild(refreshBtn);
        }

        if (acc.type === 'gemini') {
          const quotaBtn = document.createElement('button');
          quotaBtn.className = 'btn-secondary';
          quotaBtn.textContent = 'æŸ¥çœ‹é…é¢';
          quotaBtn.onclick = () => viewQuota(acc.id);
          actions.appendChild(quotaBtn);
        }

        const editBtn = document.createElement('button');
        editBtn.className = 'btn-secondary';
        editBtn.textContent = 'ç¼–è¾‘';
        editBtn.onclick = () => editAccount(acc);
        actions.appendChild(editBtn);

        const delBtn = document.createElement('button');
        delBtn.className = 'btn-danger';
        delBtn.textContent = 'åˆ é™¤';
        delBtn.onclick = () => deleteAccount(acc.id);

        actions.appendChild(delBtn);
        card.appendChild(actions);

        root.appendChild(card);
      }
    }

    async function loadAccounts() {
      try {
        const r = await authFetch('/v2/accounts');
        allAccounts = await r.json();
        applyFilters();
      } catch (e) {
        alert('åŠ è½½å¤±è´¥ï¼š' + e);
      }
    }

    function applyFilters() {
      let filtered = [...allAccounts];

      const filterType = document.getElementById('filter_type').value;
      if (filterType !== 'all') {
        filtered = filtered.filter(acc => (acc.type || 'amazonq') === filterType);
      }

      const startDate = document.getElementById('filter_start_date').value;
      const endDate = document.getElementById('filter_end_date').value;

      if (startDate) {
        filtered = filtered.filter(acc => acc.created_at >= startDate);
      }

      if (endDate) {
        const endDateTime = endDate + 'T23:59:59';
        filtered = filtered.filter(acc => acc.created_at <= endDateTime);
      }

      renderAccounts(filtered);
    }

    function clearFilters() {
      document.getElementById('filter_type').value = 'all';
      document.getElementById('filter_start_date').value = '';
      document.getElementById('filter_end_date').value = '';
      applyFilters();
    }

    function updateSelectedCount() {
      const count = selectedIds.size;
      document.getElementById('selected_count').textContent = `å·²é€‰æ‹©: ${count}`;
      document.getElementById('batch_delete_btn').style.display = count > 0 ? 'inline-block' : 'none';
      document.getElementById('test_selected_btn').style.display = count > 0 ? 'inline-block' : 'none';
      document.getElementById('export_selected_btn').style.display = count > 0 ? 'inline-block' : 'none';
    }

    function toggleSelectAll() {
      const selectAll = document.getElementById('select_all').checked;
      const root = document.getElementById('accounts');
      const cards = root.querySelectorAll('.card');

      if (selectAll) {
        cards.forEach((card, idx) => {
          const acc = allAccounts.filter(a => {
            const filterType = document.getElementById('filter_type').value;
            const startDate = document.getElementById('filter_start_date').value;
            const endDate = document.getElementById('filter_end_date').value;

            if (filterType !== 'all' && (a.type || 'amazonq') !== filterType) return false;
            if (startDate && a.created_at < startDate) return false;
            if (endDate && a.created_at > endDate + 'T23:59:59') return false;
            return true;
          })[idx];

          if (acc) selectedIds.add(acc.id);
        });
      } else {
        selectedIds.clear();
      }

      applyFilters();
      updateSelectedCount();
    }

    async function batchDelete() {
      if (selectedIds.size === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è´¦å·');
        return;
      }

      if (!confirm(`ç¡®è®¤åˆ é™¤é€‰ä¸­çš„ ${selectedIds.size} ä¸ªè´¦å·ï¼Ÿ`)) return;

      let success = 0, failed = 0;
      const ids = Array.from(selectedIds);

      for (const id of ids) {
        try {
          const r = await authFetch('/v2/accounts/' + encodeURIComponent(id), { method: 'DELETE' });
          if (r.ok) {
            success++;
          } else {
            failed++;
          }
        } catch (e) {
          failed++;
        }
      }

      selectedIds.clear();
      document.getElementById('select_all').checked = false;
      updateSelectedCount();

      alert(`åˆ é™¤å®Œæˆ: ${success} æˆåŠŸ, ${failed} å¤±è´¥`);
      await loadAccounts();
    }

    async function createAccount() {
      const type = document.getElementById('new_type').value;
      const other = {};
      if (type === 'gemini') {
        const project = document.getElementById('new_project').value.trim();
        const api_endpoint = document.getElementById('new_api_endpoint').value.trim();
        if (project) other.project = project;
        if (api_endpoint) other.api_endpoint = api_endpoint;
      } else if (type === 'custom_api') {
        const api_base = document.getElementById('new_api_base').value.trim();
        const model = document.getElementById('new_model').value.trim();
        const format = document.getElementById('new_format').value;
        const provider = document.getElementById('new_provider').value;
        if (!api_base) {
          alert('è¯·è¾“å…¥ API Base URL');
          return;
        }
        if (!model) {
          alert('è¯·è¾“å…¥ Model');
          return;
        }
        other.api_base = api_base;
        other.model = model;
        other.format = format;
        if (provider) other.provider = provider;
      }

      // Collect and validate model mappings
      const mappings = getMappingsFromUI();
      const validation = validateMappings(mappings);
      if (!validation.valid) {
        alert(validation.error);
        return;
      }
      
      // Add mappings to other field if present
      if (mappings.length > 0) {
        other.modelMappings = mappings;
      }

      const weightVal = parseInt(document.getElementById('new_weight').value) || 50;
      const body = {
        type,
        label: document.getElementById('new_label').value.trim() || null,
        clientId: type === 'custom_api' ? '' : document.getElementById('new_clientId').value.trim(),
        clientSecret: document.getElementById('new_clientSecret').value.trim(),
        refreshToken: type === 'custom_api' ? null : (document.getElementById('new_refreshToken').value.trim() || null),
        accessToken: type === 'custom_api' ? null : (document.getElementById('new_accessToken').value.trim() || null),
        other: Object.keys(other).length > 0 ? other : null,
        enabled: document.getElementById('new_enabled').checked,
        weight: Math.max(1, weightVal)
      };

      try {
        const r = await authFetch('/v2/accounts', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify(body)
        });
        if (!r.ok) throw new Error(await r.text());
        await loadAccounts();
        // æ¸…ç©ºè¡¨å•
        document.getElementById('new_label').value = '';
        document.getElementById('new_clientId').value = '';
        document.getElementById('new_clientSecret').value = '';
        document.getElementById('new_refreshToken').value = '';
        document.getElementById('new_accessToken').value = '';
        document.getElementById('new_project').value = '';
        document.getElementById('new_api_endpoint').value = '';
        document.getElementById('new_api_base').value = '';
        document.getElementById('new_model').value = '';
        document.getElementById('new_format').value = 'openai';
        document.getElementById('new_weight').value = '50';
        // æ¸…ç©ºæ¨¡å‹æ˜ å°„
        currentMappings = [];
        renderMappingList(currentMappings);
      } catch (e) {
        alert('åˆ›å»ºå¤±è´¥ï¼š' + e);
      }
    }

    async function deleteAccount(id) {
      if (!confirm('ç¡®è®¤åˆ é™¤è¯¥è´¦å·ï¼Ÿ')) return;
      try {
        const r = await authFetch('/v2/accounts/' + encodeURIComponent(id), { method: 'DELETE' });
        if (!r.ok) throw new Error(await r.text());
        await loadAccounts();
      } catch (e) {
        alert('åˆ é™¤å¤±è´¥ï¼š' + e);
      }
    }

    async function updateAccount(id, patch) {
      try {
        const r = await authFetch('/v2/accounts/' + encodeURIComponent(id), {
          method: 'PATCH',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify(patch)
        });
        if (!r.ok) throw new Error(await r.text());
        await loadAccounts();
      } catch (e) {
        alert('æ›´æ–°å¤±è´¥ï¼š' + e);
      }
    }

    async function refreshAccount(id) {
      try {
        const r = await authFetch('/v2/accounts/' + encodeURIComponent(id) + '/refresh', { method: 'POST' });
        if (!r.ok) throw new Error(await r.text());
        await loadAccounts();
      } catch (e) {
        alert('åˆ·æ–°å¤±è´¥ï¼š' + e);
      }
    }

    async function editAccount(acc) {
      const other = acc.other || {};
      
      // Load existing mappings into currentMappings for editing
      currentMappings = other.modelMappings ? JSON.parse(JSON.stringify(other.modelMappings)) : [];
      
      let html = '<div style="padding:20px;max-height:70vh;overflow-y:auto">';
      html += '<h3 style="margin-top:0">ç¼–è¾‘è´¦å·</h3>';
      html += '<div style="display:flex;flex-direction:column;gap:12px">';
      html += `<div><label style="display:block;margin-bottom:4px;color:var(--muted);font-size:13px">æ ‡ç­¾</label><input id="edit_label" value="${acc.label || ''}" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text)"></div>`;
      html += `<div><label style="display:block;margin-bottom:4px;color:var(--muted);font-size:13px">æƒé‡ï¼ˆè¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼Œå»ºè®®1-100ï¼‰</label><input id="edit_weight" type="number" min="1" max="100" value="${acc.weight || 50}" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text)"></div>`;

      if (acc.type === 'custom_api') {
        // Custom API specific fields
        html += `<div><label style="display:block;margin-bottom:4px;color:var(--muted);font-size:13px">API Key</label><input id="edit_clientSecret" type="password" value="${acc.clientSecret}" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text)"></div>`;
        html += `<div><label style="display:block;margin-bottom:4px;color:var(--muted);font-size:13px">API Base URL</label><input id="edit_api_base" value="${other.api_base || ''}" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text)"></div>`;
        html += `<div><label style="display:block;margin-bottom:4px;color:var(--muted);font-size:13px">Model</label><input id="edit_model" value="${other.model || ''}" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text)"></div>`;
        html += `<div><label style="display:block;margin-bottom:4px;color:var(--muted);font-size:13px">API Format</label><select id="edit_format" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text)"><option value="openai" ${other.format !== 'claude' ? 'selected' : ''}>OpenAI</option><option value="claude" ${other.format === 'claude' ? 'selected' : ''}>Claude</option></select></div>`;
        html += `<div><label style="display:block;margin-bottom:4px;color:var(--muted);font-size:13px">Providerï¼ˆæä¾›å•†ï¼‰</label><select id="edit_provider" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text)"><option value="" ${!other.provider ? 'selected' : ''}>é»˜è®¤ï¼ˆå®˜æ–¹ APIï¼‰</option><option value="azure" ${other.provider === 'azure' ? 'selected' : ''}>Azureï¼ˆAzure Foundryï¼‰</option><option value="anthropic" ${other.provider === 'anthropic' ? 'selected' : ''}>Anthropicï¼ˆå®˜æ–¹ï¼‰</option><option value="openai" ${other.provider === 'openai' ? 'selected' : ''}>OpenAI</option><option value="other" ${other.provider === 'other' ? 'selected' : ''}>å…¶ä»–</option></select></div>`;
      } else {
        // Standard OAuth fields
        html += `<div><label style="display:block;margin-bottom:4px;color:var(--muted);font-size:13px">Client ID</label><input id="edit_clientId" value="${acc.clientId}" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text)"></div>`;
        html += `<div><label style="display:block;margin-bottom:4px;color:var(--muted);font-size:13px">Client Secret</label><input id="edit_clientSecret" type="password" value="${acc.clientSecret}" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text)"></div>`;
        html += `<div><label style="display:block;margin-bottom:4px;color:var(--muted);font-size:13px">Refresh Token</label><input id="edit_refreshToken" type="password" value="${acc.refreshToken || ''}" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text)"></div>`;
        if (acc.type === 'gemini') {
          html += `<div><label style="display:block;margin-bottom:4px;color:var(--muted);font-size:13px">Project ID</label><input id="edit_project" value="${other.project || ''}" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text)"></div>`;
          html += `<div><label style="display:block;margin-bottom:4px;color:var(--muted);font-size:13px">API Endpoint</label><input id="edit_api_endpoint" value="${other.api_endpoint || ''}" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text)"></div>`;
        }
      }
      
      // Add model mapping section to edit modal
      html += '<div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">';
      html += '<h4 style="margin:0 0 8px 0;font-size:15px">ğŸ”„ æ¨¡å‹æ˜ å°„ï¼ˆå¯é€‰ï¼‰</h4>';
      html += '<p style="color:var(--muted);font-size:12px;margin-bottom:12px">é…ç½®æ¨¡å‹æ˜ å°„å…³ç³»ã€‚å·¦ä¾§æ˜¯å®¢æˆ·ç«¯è¯·æ±‚çš„æ¨¡å‹ï¼Œå³ä¾§æ˜¯å®é™…å‘é€ç»™APIçš„æ¨¡å‹ã€‚</p>';
      html += '<div style="display:flex;gap:8px;margin-bottom:12px">';
      html += '<button type="button" onclick="addQuickMapping(\'claude-sonnet-4-5-20250929\', \'claude-sonnet-4-5\')" style="padding:6px 12px;border-radius:8px;border:none;background:var(--muted);color:white;cursor:pointer;font-size:12px">+ Sonnet 4.5</button>';
      html += '<button type="button" onclick="addQuickMapping(\'claude-haiku-4-5-20251001\', \'claude-haiku-4-5\')" style="padding:6px 12px;border-radius:8px;border:none;background:var(--muted);color:white;cursor:pointer;font-size:12px">+ Haiku 4.5</button>';
      html += '<button type="button" onclick="addQuickMapping(\'claude-opus-4-5-20251101\', \'claude-opus-4-5\')" style="padding:6px 12px;border-radius:8px;border:none;background:var(--muted);color:white;cursor:pointer;font-size:12px">+ Opus 4.5</button>';
      html += '</div>';
      html += '<div id="edit_mapping_list" style="display:flex;flex-direction:column;gap:8px;margin-bottom:12px"></div>';
      html += '<button type="button" onclick="addMappingRow()" style="padding:6px 12px;border-radius:8px;border:none;background:var(--muted);color:white;cursor:pointer;font-size:12px">â• æ·»åŠ æ¨¡å‹æ˜ å°„</button>';
      html += '</div>';
      
      html += '</div></div>';

      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000';
      modal.innerHTML = `<div style="background:var(--panel);border-radius:16px;max-width:500px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.3)">${html}<div style="padding:16px;display:flex;gap:8px;justify-content:flex-end;border-top:1px solid var(--border)"><button onclick="this.closest('div[style*=fixed]').remove()" style="padding:8px 16px;border-radius:8px;border:none;background:var(--muted);color:white;cursor:pointer">å–æ¶ˆ</button><button id="save_edit" style="padding:8px 16px;border-radius:8px;border:none;background:var(--accent);color:white;cursor:pointer">ä¿å­˜</button></div></div>`;
      document.body.appendChild(modal);
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
      
      // Render existing mappings in the edit modal
      renderEditMappingList();

      document.getElementById('save_edit').onclick = async () => {
        try {
          // Collect and validate model mappings
          const mappings = getMappingsFromUI();
          const validation = validateMappings(mappings);
          if (!validation.valid) {
            alert(validation.error);
            return;
          }
          
          const weightVal = parseInt(document.getElementById('edit_weight').value) || 50;
          const patch = {
            label: document.getElementById('edit_label').value.trim() || null,
            clientSecret: document.getElementById('edit_clientSecret').value.trim(),
            weight: Math.max(1, weightVal)
          };

          if (acc.type === 'custom_api') {
            const newOther = { ...other };
            const api_base = document.getElementById('edit_api_base').value.trim();
            const model = document.getElementById('edit_model').value.trim();
            const format = document.getElementById('edit_format').value;

            if (!api_base) {
              alert('è¯·è¾“å…¥ API Base URL');
              return;
            }
            if (!model) {
              alert('è¯·è¾“å…¥ Model');
              return;
            }

            newOther.api_base = api_base;
            newOther.model = model;
            newOther.format = format;
            newOther.provider = document.getElementById('edit_provider').value;
            
            // Add or remove model mappings
            if (mappings.length > 0) {
              newOther.modelMappings = mappings;
            } else {
              delete newOther.modelMappings;
            }
            
            patch.other = newOther;
          } else {
            patch.clientId = document.getElementById('edit_clientId').value.trim();
            patch.refreshToken = document.getElementById('edit_refreshToken').value.trim() || null;

            if (acc.type === 'gemini') {
              const newOther = { ...other };
              const project = document.getElementById('edit_project').value.trim();
              const api_endpoint = document.getElementById('edit_api_endpoint').value.trim();

              if (project) {
                newOther.project = project;
              } else {
                delete newOther.project;
              }

              if (api_endpoint) {
                newOther.api_endpoint = api_endpoint;
              } else {
                delete newOther.api_endpoint;
              }

              // Add or remove model mappings
              if (mappings.length > 0) {
                newOther.modelMappings = mappings;
              } else {
                delete newOther.modelMappings;
              }

              patch.other = newOther;
            } else {
              // For amazonq accounts, handle mappings in other field
              if (mappings.length > 0 || (other && other.modelMappings)) {
                const newOther = { ...other };
                if (mappings.length > 0) {
                  newOther.modelMappings = mappings;
                } else {
                  delete newOther.modelMappings;
                }
                patch.other = newOther;
              }
            }
          }

          await updateAccount(acc.id, patch);
          modal.remove();
        } catch (e) {
          alert('ä¿å­˜å¤±è´¥ï¼š' + e.message);
        }
      };
    }

    async function viewQuota(id) {
      try {
        const r = await authFetch(`/v2/accounts/${id}/quota`);
        if (!r.ok) throw new Error(await r.text());
        const data = await r.json();

        let html = '<div style="max-height:500px;overflow-y:auto;padding:16px;background:var(--bg);border-radius:12px">';
        html += '<h3 style="margin-top:0">é…é¢ä¿¡æ¯</h3>';

        if (data.models) {
          for (const [modelId, model] of Object.entries(data.models)) {
            const quota = model.quotaInfo || {};
            const remaining = (quota.remainingFraction * 100).toFixed(1);
            const resetTime = quota.resetTime ? new Date(quota.resetTime).toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' }) : 'N/A';

            html += `<div style="margin-bottom:16px;padding:12px;background:var(--panel);border-radius:8px">`;
            html += `<div style="font-weight:600;margin-bottom:8px">${model.displayName || modelId}</div>`;
            html += `<div style="font-size:14px;color:var(--muted)">å‰©ä½™é…é¢: <span style="color:${remaining > 20 ? 'var(--success)' : 'var(--danger)'}; font-weight:600">${remaining}%</span></div>`;
            html += `<div style="font-size:14px;color:var(--muted)">é‡ç½®æ—¶é—´: ${resetTime}</div>`;
            if (model.maxTokens) html += `<div style="font-size:14px;color:var(--muted)">æœ€å¤§Token: ${model.maxTokens.toLocaleString()}</div>`;
            html += `</div>`;
          }
        }

        html += '</div>';

        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000';
        modal.innerHTML = `<div style="background:var(--panel);border-radius:16px;max-width:600px;width:90%;max-height:80vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3)">${html}<div style="padding:16px;text-align:right"><button onclick="this.closest('div[style*=fixed]').remove()" style="padding:8px 16px;border-radius:8px;border:none;background:var(--accent);color:white;cursor:pointer">å…³é—­</button></div></div>`;
        document.body.appendChild(modal);
        modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
      } catch (e) {
        alert('è·å–é…é¢å¤±è´¥ï¼š' + e.message);
      }
    }

    function setImportStatus(text, ok = true) {
      const el = document.getElementById('import_status');
      el.textContent = text;
      el.className = ok ? 'chip success' : 'chip danger';
      el.style.display = 'inline-flex';
    }

    async function importAccounts() {
      const data = document.getElementById('import_data').value.trim();
      if (!data) {
        alert('è¯·è¾“å…¥è´¦å·æ•°æ®');
        return;
      }

      const lines = data.split('\n').filter(l => l.trim() && !l.trim().startsWith('#'));
      if (lines.length === 0) {
        alert('æ²¡æœ‰æœ‰æ•ˆçš„è´¦å·æ•°æ®');
        return;
      }

      const importType = document.getElementById('import_type').value;
      setImportStatus(`å‡†å¤‡å¯¼å…¥ ${lines.length} ä¸ªè´¦å·...`, true);

      let success = 0, failed = 0;
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        const parts = line.split('|').map(p => p.trim());

        let type, label, clientId, clientSecret, refreshToken, accessToken, project, api_endpoint, weight, rateLimit, otherJson;

        if (importType === 'amazonq') {
          if (parts.length < 6) {
            console.error(`ç¬¬ ${i + 1} è¡Œæ ¼å¼é”™è¯¯: æœŸæœ›6ä¸ªå­—æ®µï¼Œå®é™…${parts.length}ä¸ª`, line);
            setImportStatus(`ç¬¬ ${i + 1} è¡Œæ ¼å¼é”™è¯¯ (${parts.length}å­—æ®µ)`, false);
            failed++;
            continue;
          }
          // email|password|clientId|clientSecret|refreshToken|accessToken
          const [email, password, ...rest] = parts;
          [clientId, clientSecret, refreshToken, accessToken] = rest;
          label = email; // ä½¿ç”¨ email ä½œä¸º label
          type = 'amazonq';
          weight = 50;
          rateLimit = 20;
        } else if (importType === 'gemini') {
          if (parts.length < 5) {
            setImportStatus(`ç¬¬ ${i + 1} è¡Œæ ¼å¼é”™è¯¯`, false);
            failed++;
            continue;
          }
          [label, clientId, clientSecret, refreshToken, accessToken, project, api_endpoint] = parts;
          type = 'gemini';
          weight = 50;
          rateLimit = 20;
        } else {
          // å®Œæ•´æ ¼å¼ï¼šè‡ªåŠ¨æ£€æµ‹æ–°æ—§æ ¼å¼
          if (parts.length < 6) {
            setImportStatus(`ç¬¬ ${i + 1} è¡Œæ ¼å¼é”™è¯¯`, false);
            failed++;
            continue;
          }
          
          // æ–°æ ¼å¼ï¼ˆ11å­—æ®µï¼‰ï¼štype|label|clientId|clientSecret|refreshToken|accessToken|project|api_endpoint|weight|rate_limit|other_json
          // æ—§æ ¼å¼ï¼ˆ8å­—æ®µï¼‰ï¼štype|label|clientId|clientSecret|refreshToken|accessToken|project|api_endpoint
          if (parts.length >= 11) {
            // æ–°æ ¼å¼
            [type, label, clientId, clientSecret, refreshToken, accessToken, project, api_endpoint, weight, rateLimit, otherJson] = parts;
            weight = parseInt(weight) || 50;
            rateLimit = parseInt(rateLimit) || 20;
          } else {
            // æ—§æ ¼å¼ï¼ˆå‘åå…¼å®¹ï¼‰
            [type, label, clientId, clientSecret, refreshToken, accessToken, project, api_endpoint] = parts;
            weight = 50;
            rateLimit = 20;
            otherJson = '';
          }
        }

        // æ„å»º other å¯¹è±¡
        const other = {};
        if (project) other.project = project;
        if (api_endpoint) other.api_endpoint = api_endpoint;
        
        // åˆå¹¶ otherJson ä¸­çš„é¢å¤–å­—æ®µ
        if (otherJson) {
          try {
            const parsedOther = JSON.parse(otherJson);
            Object.assign(other, parsedOther);
          } catch (e) {
            console.warn(`ç¬¬ ${i + 1} è¡Œ: æ— æ³•è§£æ other JSONï¼Œè·³è¿‡`, e);
          }
        }

        try {
          const r = await authFetch('/v2/accounts', {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({
              type: type || 'amazonq',
              label,
              clientId,
              clientSecret,
              refreshToken: refreshToken || null,
              accessToken: accessToken || null,
              other: Object.keys(other).length > 0 ? other : null,
              enabled: true,
              weight: weight,
              rate_limit_per_hour: rateLimit
            })
          });

          if (r.ok) {
            success++;
            setImportStatus(`å¯¼å…¥ä¸­... ${success}/${lines.length}`, true);
          } else {
            const errorText = await r.text();
            console.error(`ç¬¬ ${i + 1} è¡Œå¯¼å…¥å¤±è´¥:`, errorText);
            failed++;
            setImportStatus(`å¯¼å…¥ä¸­... ${success} æˆåŠŸ, ${failed} å¤±è´¥`, false);
          }
        } catch (e) {
          console.error(`ç¬¬ ${i + 1} è¡Œå¯¼å…¥å¼‚å¸¸:`, e);
          failed++;
          setImportStatus(`å¯¼å…¥ä¸­... ${success} æˆåŠŸ, ${failed} å¤±è´¥`, false);
        }
      }

      setImportStatus(`å®Œæˆ: ${success} æˆåŠŸ, ${failed} å¤±è´¥`, failed === 0);
      await loadAccounts();
      if (failed === 0) document.getElementById('import_data').value = '';
    }

    function setTestStatus(text, ok = true) {
      const el = document.getElementById('test_status');
      el.textContent = text;
      el.className = ok ? 'chip success' : 'chip danger';
      el.style.display = 'inline-flex';
    }

    async function exportAccounts(exportSelected = false) {
      try {
        const r = await authFetch('/v2/accounts');
        let accounts = await r.json();
        
        // å¦‚æœæŒ‡å®šå¯¼å‡ºé€‰ä¸­çš„è´¦å·
        if (exportSelected) {
          if (selectedIds.size === 0) {
            alert('è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„è´¦å·');
            return;
          }
          accounts = accounts.filter(acc => selectedIds.has(acc.id));
        }
        
        if (accounts.length === 0) {
          alert('æ²¡æœ‰è´¦å·å¯å¯¼å‡º');
          return;
        }

        // æ–°æ ¼å¼ï¼štype|label|clientId|clientSecret|refreshToken|accessToken|project|api_endpoint|weight|rate_limit|other_json
        const lines = accounts.map(acc => {
          const other = acc.other || {};
          const weight = acc.weight || 50;
          const rateLimit = acc.rate_limit_per_hour || 20;
          
          // åºåˆ—åŒ– other å­—æ®µä¸º JSONï¼ˆæ’é™¤å·²å•ç‹¬å¯¼å‡ºçš„å­—æ®µï¼‰
          const otherCopy = { ...other };
          delete otherCopy.project;
          delete otherCopy.api_endpoint;
          const otherJson = Object.keys(otherCopy).length > 0 ? JSON.stringify(otherCopy) : '';
          
          // ç»Ÿä¸€æ ¼å¼ï¼Œæ‰€æœ‰è´¦å·ç±»å‹ä½¿ç”¨ç›¸åŒçš„11å­—æ®µæ ¼å¼
          return `${acc.type || 'amazonq'}|${acc.label || ''}|${acc.clientId || ''}|${acc.clientSecret || ''}|${acc.refreshToken || ''}|${acc.accessToken || ''}|${other.project || ''}|${other.api_endpoint || ''}|${weight}|${rateLimit}|${otherJson}`;
        });

        const content = lines.join('\n');
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const suffix = exportSelected ? `selected_${accounts.length}` : 'all';
        a.download = `accounts_${suffix}_${new Date().toISOString().split('T')[0]}.txt`;
        a.click();
        URL.revokeObjectURL(url);
      } catch (e) {
        alert('å¯¼å‡ºå¤±è´¥ï¼š' + e);
      }
    }

    async function testSingleAccount(accountId) {
      const msg = document.getElementById('test_message').value.trim() || 'Hello';
      const accounts = await (await authFetch('/v2/accounts')).json();
      const acc = accounts.find(a => a.id === accountId);

      if (!acc) {
        alert('è´¦å·ä¸å­˜åœ¨');
        return;
      }

      setTestStatus(`æµ‹è¯• ${acc.label}...`, true);
      document.getElementById('test_results').innerHTML = '';

      try {
        // Custom API accounts use dedicated test endpoint
        if (acc.type === 'custom_api') {
          const headers = { 'content-type': 'application/json' };
          const sessionToken = getSessionToken();
          if (sessionToken) headers['X-Session-Token'] = sessionToken;

          const r = await fetch(`/v2/accounts/${accountId}/test`, {
            method: 'POST',
            headers
          });

          const result = await r.json();

          if (result.success) {
            setTestStatus(`æµ‹è¯•æˆåŠŸ`, true);
            const details = result.details || {};
            document.getElementById('test_results').innerHTML = `<div class="card"><div style="color:var(--success)">âœ“ ${acc.label}</div><div style="font-size:12px;margin-top:8px"><strong>API:</strong> ${details.api_base}<br><strong>æ¨¡å‹:</strong> ${details.model}<br><strong>æ ¼å¼:</strong> ${details.format}<br><strong>å“åº”:</strong> ${details.response_preview || '(æ— )'}</div></div>`;
          } else {
            setTestStatus(`æµ‹è¯•å¤±è´¥`, false);
            const details = result.details || {};
            document.getElementById('test_results').innerHTML = `<div class="card"><div style="color:var(--danger)">âœ— ${acc.label}</div><div style="font-size:12px;margin-top:8px">${result.error}<br><strong>API:</strong> ${details.api_base || 'N/A'}<br><strong>æ¨¡å‹:</strong> ${details.model || 'N/A'}</div></div>`;
          }
          return;
        }

        // Determine endpoint and model based on account type
        let endpoint, model;
        if (acc.type === 'gemini') {
          endpoint = '/v1/gemini/messages';
          model = 'gemini-3-pro-high';
        } else {
          endpoint = '/v1/messages';
          model = 'claude-sonnet-4';
        }

        const headers = {
          'content-type': 'application/json',
          'X-Account-ID': accountId
        };
        const sessionToken = getSessionToken();
        if (sessionToken) headers['X-Session-Token'] = sessionToken;

        const r = await fetch(endpoint, {
          method: 'POST',
          headers,
          body: JSON.stringify({
            model: model,
            max_tokens: 50,
            messages: [{ role: 'user', content: msg }]
          })
        });

        if (!r.ok) {
          const errText = await r.text();
          setTestStatus(`æµ‹è¯•å¤±è´¥`, false);
          document.getElementById('test_results').innerHTML = `<div class="card"><div style="color:var(--danger)">âœ— ${acc.label}</div><div style="font-size:12px;margin-top:8px">${errText}</div></div>`;
          return;
        }

        const reader = r.body.getReader();
        const decoder = new TextDecoder();
        let text = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value);
          const lines = chunk.split('\n');

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = line.slice(6);
              if (data === '[DONE]') continue;
              try {
                const json = JSON.parse(data);
                if (json.type === 'content_block_delta' && json.delta?.text) {
                  text += json.delta.text;
                }
              } catch (e) { }
            }
          }
        }

        setTestStatus(`æµ‹è¯•æˆåŠŸ`, true);
        document.getElementById('test_results').innerHTML = `<div class="card"><div style="color:var(--success)">âœ“ ${acc.label}</div><div class="mono" style="font-size:12px;margin-top:8px">${text}</div></div>`;
      } catch (e) {
        setTestStatus(`æµ‹è¯•å¤±è´¥`, false);
        document.getElementById('test_results').innerHTML = `<div class="card"><div style="color:var(--danger)">âœ— ${acc.label}</div><div style="font-size:12px;margin-top:8px">${e}</div></div>`;
      }
    }

    async function testSelectedAccounts() {
      if (selectedIds.size === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¦æµ‹è¯•çš„è´¦å·');
        return;
      }

      const msg = document.getElementById('test_message').value.trim() || 'Hello';
      const accounts = await (await authFetch('/v2/accounts')).json();
      const toTest = accounts.filter(a => selectedIds.has(a.id));

      setTestStatus(`æµ‹è¯• ${toTest.length} ä¸ªè´¦å·...`, true);
      document.getElementById('test_results').innerHTML = '';

      let success = 0, failed = 0;
      const results = [];

      for (const acc of toTest) {
        try {
          // Determine endpoint and model based on account type
          let endpoint, model;
          if (acc.type === 'gemini') {
            endpoint = '/v1/gemini/messages';
            model = 'gemini-3-pro-high';
          } else if (acc.type === 'custom_api') {
            endpoint = '/v1/messages';
            const other = acc.other || {};
            model = other.model || 'gpt-4o';
          } else {
            endpoint = '/v1/messages';
            model = 'claude-sonnet-4';
          }

          const headers = {
            'content-type': 'application/json',
            'X-Account-ID': acc.id
          };
          const sessionToken = getSessionToken();
          if (sessionToken) headers['X-Session-Token'] = sessionToken;

          const r = await fetch(endpoint, {
            method: 'POST',
            headers,
            body: JSON.stringify({
              model: model,
              max_tokens: 50,
              messages: [{ role: 'user', content: msg }]
            })
          });

          if (!r.ok) {
            failed++;
            results.push(`<div class="card"><div style="color:var(--danger)">âœ— ${acc.label}</div><div style="font-size:12px;margin-top:8px">${await r.text()}</div></div>`);
            setTestStatus(`æµ‹è¯•ä¸­... ${success + failed}/${toTest.length}`, true);
            continue;
          }

          const reader = r.body.getReader();
          const decoder = new TextDecoder();
          let text = '';

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');

            for (const line of lines) {
              if (line.startsWith('data: ')) {
                const data = line.slice(6);
                if (data === '[DONE]') continue;
                try {
                  const json = JSON.parse(data);
                  if (json.type === 'content_block_delta' && json.delta?.text) {
                    text += json.delta.text;
                  }
                } catch (e) { }
              }
            }
          }

          success++;
          results.push(`<div class="card"><div style="color:var(--success)">âœ“ ${acc.label}</div><div class="mono" style="font-size:12px;margin-top:8px">${text.substring(0, 100)}${text.length > 100 ? '...' : ''}</div></div>`);
          setTestStatus(`æµ‹è¯•ä¸­... ${success + failed}/${toTest.length}`, true);
        } catch (e) {
          failed++;
          results.push(`<div class="card"><div style="color:var(--danger)">âœ— ${acc.label}</div><div style="font-size:12px;margin-top:8px">${e}</div></div>`);
        }
      }

      setTestStatus(`å®Œæˆ: ${success} æˆåŠŸ, ${failed} å¤±è´¥`, failed === 0);
      document.getElementById('test_results').innerHTML = results.join('');
    }

    async function testAllAccounts() {
      const msg = document.getElementById('test_message').value.trim() || 'Hello';
      const accounts = await (await authFetch('/v2/accounts')).json();
      const enabled = accounts.filter(a => a.enabled);

      if (enabled.length === 0) {
        alert('æ²¡æœ‰å¯ç”¨çš„è´¦å·');
        return;
      }

      setTestStatus(`æµ‹è¯• ${enabled.length} ä¸ªè´¦å·...`, true);
      document.getElementById('test_results').innerHTML = '';

      let success = 0, failed = 0;
      const results = [];

      for (const acc of enabled) {
        try {
          // Determine endpoint and model based on account type
          let endpoint, model;
          if (acc.type === 'gemini') {
            endpoint = '/v1/gemini/messages';
            model = 'gemini-3-pro-high';
          } else if (acc.type === 'custom_api') {
            endpoint = '/v1/messages';
            const other = acc.other || {};
            model = other.model || 'gpt-4o';
          } else {
            endpoint = '/v1/messages';
            model = 'claude-sonnet-4';
          }

          const headers = {
            'content-type': 'application/json',
            'X-Account-ID': acc.id
          };
          const sessionToken = getSessionToken();
          if (sessionToken) headers['X-Session-Token'] = sessionToken;

          const r = await fetch(endpoint, {
            method: 'POST',
            headers,
            body: JSON.stringify({
              model: model,
              max_tokens: 50,
              messages: [{ role: 'user', content: msg }]
            })
          });

          if (!r.ok) {
            failed++;
            results.push(`<div class="card"><div style="color:var(--danger)">âœ— ${acc.label}</div><div style="font-size:12px;margin-top:8px">${await r.text()}</div></div>`);
            setTestStatus(`æµ‹è¯•ä¸­... ${success + failed}/${enabled.length}`, true);
            continue;
          }

          const reader = r.body.getReader();
          const decoder = new TextDecoder();
          let text = '';

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');

            for (const line of lines) {
              if (line.startsWith('data: ')) {
                const data = line.slice(6);
                if (data === '[DONE]') continue;
                try {
                  const json = JSON.parse(data);
                  if (json.type === 'content_block_delta' && json.delta?.text) {
                    text += json.delta.text;
                  }
                } catch (e) { }
              }
            }
          }

          success++;
          results.push(`<div class="card"><div style="color:var(--success)">âœ“ ${acc.label}</div><div class="mono" style="font-size:12px;margin-top:8px">${text.substring(0, 100)}${text.length > 100 ? '...' : ''}</div></div>`);
          setTestStatus(`æµ‹è¯•ä¸­... ${success + failed}/${enabled.length}`, true);
        } catch (e) {
          failed++;
          results.push(`<div class="card"><div style="color:var(--danger)">âœ— ${acc.label}</div><div style="font-size:12px;margin-top:8px">${e}</div></div>`);
        }
      }

      setTestStatus(`å®Œæˆ: ${success} æˆåŠŸ, ${failed} å¤±è´¥`, failed === 0);
      document.getElementById('test_results').innerHTML = results.join('');
    }

    async function refreshAllTokens() {
      if (!confirm('ç¡®è®¤æ‰¹é‡åˆ·æ–°æ‰€æœ‰ Amazon Q è´¦å·çš„ Tokenï¼Ÿè¿™å°†æ£€æµ‹å‡ºæ‰€æœ‰è¢«å°ç¦çš„è´¦å·ã€‚')) {
        return;
      }

      setTestStatus('æ­£åœ¨æ‰¹é‡åˆ·æ–° Token...', true);
      document.getElementById('test_results').innerHTML = '';

      try {
        const r = await authFetch('/v2/accounts/refresh-all', { method: 'POST' });
        if (!r.ok) throw new Error(await r.text());

        const data = await r.json();

        // æ˜¾ç¤ºç»“æœç»Ÿè®¡
        setTestStatus(data.message, data.banned_count === 0);

        // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
        const results = [];
        for (const result of data.results) {
          let color, icon;
          if (result.status === 'success') {
            color = 'var(--success)';
            icon = 'âœ“';
          } else if (result.status === 'banned') {
            color = 'var(--danger)';
            icon = 'âš ï¸';
          } else {
            color = 'var(--warning)';
            icon = 'âœ—';
          }

          results.push(`<div class="card"><div style="color:${color}">${icon} ${result.label}</div><div style="font-size:12px;margin-top:8px;color:var(--muted)">${result.message}</div></div>`);
        }

        document.getElementById('test_results').innerHTML = results.join('');

        // åˆ·æ–°è´¦å·åˆ—è¡¨
        await loadAccounts();
      } catch (e) {
        setTestStatus('æ‰¹é‡åˆ·æ–°å¤±è´¥', false);
        alert('æ‰¹é‡åˆ·æ–°å¤±è´¥ï¼š' + e.message);
      }
    }

    // ==================== URL ç™»å½•ï¼ˆè®¾å¤‡æˆæƒï¼‰åŠŸèƒ½ ====================
    let currentAuth = null;

    async function startAuth() {
      const label = (document.getElementById('auth_label').value || '').trim() || null;
      const enabled = document.getElementById('auth_enabled').checked;
      const infoEl = document.getElementById('auth_info');

      infoEl.textContent = 'æ­£åœ¨å¯åŠ¨ç™»å½•...';

      try {
        const r = await authFetch('/v2/auth/start', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ label, enabled })
        });

        if (!r.ok) {
          const errorText = await r.text();
          throw new Error(errorText);
        }

        const j = await r.json();
        currentAuth = j;

        const info = [
          'âœ… ç™»å½•å·²å¯åŠ¨ï¼',
          '',
          'ğŸ“‹ éªŒè¯é“¾æ¥:',
          j.verificationUriComplete,
          '',
          'ğŸ”‘ ç”¨æˆ·ä»£ç : ' + (j.userCode || 'N/A'),
          'â±ï¸ æœ‰æ•ˆæœŸ: ' + j.expiresIn + ' ç§’',
          'ğŸ†” authId: ' + j.authId,
          '',
          'ğŸ‘‰ è¯·åœ¨æ–°çª—å£ä¸­æ‰“å¼€ä¸Šè¿°é“¾æ¥å®Œæˆ AWS ç™»å½•',
          'ğŸ‘‰ ç™»å½•å®Œæˆåï¼Œç‚¹å‡»ã€Œç­‰å¾…æˆæƒå¹¶åˆ›å»ºè´¦å·ã€æŒ‰é’®'
        ].join('\n');

        infoEl.textContent = info;

        // è‡ªåŠ¨æ‰“å¼€éªŒè¯é“¾æ¥
        try {
          window.open(j.verificationUriComplete, '_blank');
        } catch (e) {
          console.warn('æ— æ³•è‡ªåŠ¨æ‰“å¼€é“¾æ¥:', e);
        }

      } catch (e) {
        infoEl.textContent = 'âŒ å¯åŠ¨å¤±è´¥ï¼š' + e.message;
      }
    }

    async function claimAuth() {
      const infoEl = document.getElementById('auth_info');

      if (!currentAuth || !currentAuth.authId) {
        infoEl.textContent = 'âš ï¸ è¯·å…ˆç‚¹å‡»ã€Œå¼€å§‹ç™»å½•ã€æŒ‰é’®å¯åŠ¨ç™»å½•æµç¨‹';
        return;
      }

      infoEl.textContent += '\n\nâ³ æ­£åœ¨ç­‰å¾…æˆæƒå¹¶åˆ›å»ºè´¦å·ï¼ˆæœ€å¤š5åˆ†é’Ÿï¼‰...\nè¯·ç¡®ä¿å·²åœ¨æµè§ˆå™¨ä¸­å®Œæˆ AWS ç™»å½•';

      try {
        const r = await authFetch('/v2/auth/claim/' + encodeURIComponent(currentAuth.authId), {
          method: 'POST'
        });

        const text = await r.text();
        let j;
        try {
          j = JSON.parse(text);
        } catch {
          j = { raw: text };
        }

        if (r.ok && j.status === 'completed') {
          infoEl.textContent = [
            'ğŸ‰ è´¦å·åˆ›å»ºæˆåŠŸï¼',
            '',
            'è´¦å· ID: ' + (j.account?.id || 'N/A'),
            'æ ‡ç­¾: ' + (j.account?.label || '(æ— )'),
            'çŠ¶æ€: ' + (j.account?.enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'),
            'åˆ›å»ºæ—¶é—´: ' + (j.account?.created_at || 'N/A'),
            '',
            'è´¦å·å·²è‡ªåŠ¨æ·»åŠ åˆ°åˆ—è¡¨ä¸­'
          ].join('\n');

          // æ¸…ç©ºå½“å‰æˆæƒçŠ¶æ€
          currentAuth = null;

          // åˆ·æ–°è´¦å·åˆ—è¡¨
          await loadAccounts();
        } else {
          infoEl.textContent = 'âŒ åˆ›å»ºå¤±è´¥ï¼š\n' + JSON.stringify(j, null, 2);
        }

      } catch (e) {
        infoEl.textContent += '\n\nâŒ å¤±è´¥ï¼š' + e.message;
      }
    }

    // ==================== Tab åˆ‡æ¢åŠŸèƒ½ ====================
    function switchTab(tabName) {
      // åˆ‡æ¢æŒ‰é’®æ¿€æ´»çŠ¶æ€
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabName);
      });
      // åˆ‡æ¢å†…å®¹æ˜¾ç¤º
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === 'tab-' + tabName);
      });
      // åˆ‡æ¢åˆ° Token ç®¡ç†æ—¶åŠ è½½æ•°æ®
      if (tabName === 'tokens' && !tokenDataLoaded) {
        fetchTokenUsageData();
        tokenDataLoaded = true;
      }
    }

    // ==================== Token ä½¿ç”¨ç»Ÿè®¡åŠŸèƒ½ ====================
    let currentPeriod = 'day';
    let tokenDataLoaded = false;

    function formatNumber(num) {
      if (num === null || num === undefined || isNaN(num)) return '0';
      num = Number(num);
      if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(2) + 'K';
      return num.toLocaleString();
    }

    function getPeriodLabel(period) {
      const labels = { 'hour': 'æœ€è¿‘1å°æ—¶', 'day': 'æœ€è¿‘24å°æ—¶', 'week': 'æœ€è¿‘7å¤©', 'month': 'æœ€è¿‘30å¤©', 'all': 'å…¨éƒ¨æ—¶é—´' };
      return labels[period] || period;
    }

    function renderTokenStats(data) {
      const grid = document.getElementById('stats-grid');
      const cacheTotal = (data.cache_read_input_tokens || 0) + (data.cache_creation_input_tokens || 0);
      const cacheHitRatio = cacheTotal === 0 ? 0 : ((data.cache_read_input_tokens || 0) / cacheTotal) * 100;

      const cards = [
        { icon: 'ğŸ“Š', iconClass: 'blue', label: 'æ€» Token æ¶ˆè€—', value: formatNumber(data.total_tokens || 0), sub: `è¾“å…¥: <span>${formatNumber(data.input_tokens || 0)}</span> | è¾“å‡º: <span>${formatNumber(data.output_tokens || 0)}</span>` },
        { icon: 'ğŸ“¨', iconClass: 'green', label: 'è¯·æ±‚æ¬¡æ•°', value: formatNumber(data.request_count || 0), sub: `ç»Ÿè®¡å‘¨æœŸ: <span>${getPeriodLabel(currentPeriod)}</span>` },
        { icon: 'ğŸ“¥', iconClass: 'cyan', label: 'è¾“å…¥ Token', value: formatNumber(data.input_tokens || 0), sub: `å æ¯”: <span>${data.total_tokens ? ((data.input_tokens / data.total_tokens) * 100).toFixed(1) : 0}%</span>` },
        { icon: 'ğŸ“¤', iconClass: 'purple', label: 'è¾“å‡º Token', value: formatNumber(data.output_tokens || 0), sub: `å æ¯”: <span>${data.total_tokens ? ((data.output_tokens / data.total_tokens) * 100).toFixed(1) : 0}%</span>` },
        { icon: 'ğŸ’¾', iconClass: 'orange', label: 'ç¼“å­˜åˆ›å»º Token', value: formatNumber(data.cache_creation_input_tokens || 0), sub: 'é¦–æ¬¡ç¼“å­˜æ¶ˆè€—' },
        { icon: 'âš¡', iconClass: 'yellow', label: 'ç¼“å­˜è¯»å– Token', value: formatNumber(data.cache_read_input_tokens || 0), sub: 'ä»ç¼“å­˜è¯»å–' },
        { icon: 'ğŸ¯', iconClass: 'pink', label: 'ç¼“å­˜å‘½ä¸­ç‡', value: cacheHitRatio.toFixed(1) + '%', sub: `åˆ›å»º: <span>${formatNumber(data.cache_creation_input_tokens || 0)}</span> | è¯»å–: <span>${formatNumber(data.cache_read_input_tokens || 0)}</span>` }
      ];

      grid.innerHTML = cards.map(card => `
        <div class="stat-card">
          <div class="stat-icon ${card.iconClass}">${card.icon}</div>
          <div class="stat-content">
            <div class="stat-label">${card.label}</div>
            <div class="stat-value">${card.value}</div>
            <div class="stat-sub">${card.sub}</div>
          </div>
        </div>
      `).join('');
    }

    async function fetchTokenUsageData() {
      try {
        const response = await fetch(`/v1/usage?period=${currentPeriod}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        renderTokenStats(data);
        document.getElementById('last-update').textContent = `ä¸Šæ¬¡æ›´æ–°: ${new Date().toLocaleTimeString('zh-CN')}`;
      } catch (error) {
        console.error('è·å– Token æ•°æ®å¤±è´¥:', error);
        document.getElementById('stats-grid').innerHTML = '<p style="color:var(--danger)">è·å–æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</p>';
      }
    }

    function refreshTokenData() {
      fetchTokenUsageData();
    }

    function initPeriodSelector() {
      document.querySelectorAll('.period-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentPeriod = btn.dataset.period;
          fetchTokenUsageData();
        });
      });
    }

    window.addEventListener('DOMContentLoaded', () => {
      setupFormValidation();
      setupLoginKeyboardSupport();
      initAuth();
      initPeriodSelector();
    });
  </script>
</body>

</html>